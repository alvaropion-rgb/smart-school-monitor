<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#6366f1">
  <meta name="format-detection" content="telephone=no">
  <title>Smart School Monitor</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Lucide Icons (pinned version for reliability) -->
  <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>

  <!-- PDF.js for PDF support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div id="app">
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
      <div class="loading-content">
        <div class="loading-icon">
          <div class="pulse-ring"></div>
          <span class="school-icon">üè´</span>
        </div>
        <h1 class="loading-title">Smart School Monitor</h1>
        <p class="loading-subtitle">Loading your network dashboard...</p>
        <div class="loading-bar">
          <div class="loading-progress"></div>
        </div>
      </div>
    </div>

    <!-- Failsafe: dismiss loading screen after 15 seconds even if JS init fails -->
    <script>
      window.__loadingDismissed = false;
      window.__dismissLoading = function() {
        if (window.__loadingDismissed) return;
        window.__loadingDismissed = true;
        var ls = document.getElementById('loading-screen');
        var ma = document.getElementById('main-app');
        if (ls) {
          ls.classList.add('hidden');
          ls.style.display = 'none';
          ls.style.pointerEvents = 'none';
          ls.style.zIndex = '-1';
        }
        if (ma) ma.classList.remove('hidden');
        try { if (typeof lucide !== 'undefined') lucide.createIcons(); } catch(e) {}
      };
      setTimeout(function() {
        if (!window.__loadingDismissed) {
          console.warn('Failsafe: Loading screen dismissed after timeout');
          window.__dismissLoading();
        }
      }, 15000);
      // Belt-and-suspenders: periodically ensure no overlay is blocking clicks
      setInterval(function() {
        if (!window.__loadingDismissed) return;
        var ls = document.getElementById('loading-screen');
        if (ls && ls.style.display !== 'none') {
          ls.style.display = 'none';
          ls.style.pointerEvents = 'none';
          ls.style.zIndex = '-1';
        }
        // Also ensure sidebar-overlay isn't stuck active
        var so = document.getElementById('sidebar-overlay');
        var sb = document.getElementById('sidebar');
        if (so && so.classList.contains('active') && sb && !sb.classList.contains('open')) {
          so.classList.remove('active');
        }
      }, 2000);
    </script>

    <!-- Main App Container -->
    <div id="main-app" class="hidden">
      <!-- Sidebar -->
      <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <span class="logo-icon">üè´</span>
            <span class="logo-text">School Monitor</span>
          </div>
          <button type="button" class="sidebar-close" onclick="toggleSidebar()">
            <i data-lucide="x"></i>
          </button>
        </div>

        <nav class="sidebar-nav">
          <button type="button" class="nav-item active" data-tab="blueprint" onclick="switchTab('blueprint')">
            <i data-lucide="map"></i>
            <span>Blueprint View</span>
          </button>
          <button type="button" class="nav-item" data-tab="dashboard" onclick="switchTab('dashboard')">
            <i data-lucide="layout-dashboard"></i>
            <span>Dashboard</span>
          </button>
          <button type="button" class="nav-item" data-tab="overview" onclick="switchTab('overview')">
            <i data-lucide="pie-chart"></i>
            <span>Overview</span>
          </button>
          <button type="button" class="nav-item" data-tab="devices" onclick="switchTab('devices')">
            <i data-lucide="printer"></i>
            <span>Devices</span>
          </button>
          <button type="button" class="nav-item" data-tab="traps" onclick="switchTab('traps')">
            <i data-lucide="bell"></i>
            <span>SNMP Traps</span>
            <span id="trap-badge" class="badge hidden">0</span>
          </button>
          <button type="button" class="nav-item" data-tab="requests" onclick="switchTab('requests')">
            <i data-lucide="clipboard-list"></i>
            <span>Service Requests</span>
            <span id="requests-badge" class="badge hidden">0</span>
          </button>
          <button type="button" class="nav-item" data-tab="helpdesk" onclick="switchTab('helpdesk')">
            <i data-lucide="headphones"></i>
            <span>Help Desk</span>
          </button>
          <button type="button" class="nav-item" data-tab="computer-repair" onclick="switchTab('computer-repair')">
            <i data-lucide="laptop"></i>
            <span>Computer Repair</span>
          </button>
          <button type="button" class="nav-item" data-tab="analytics" onclick="switchTab('analytics')">
            <i data-lucide="bar-chart-3"></i>
            <span>Analytics</span>
          </button>
          <button type="button" class="nav-item" data-tab="email" onclick="switchTab('email')">
            <i data-lucide="mail"></i>
            <span>Email Settings</span>
          </button>
          <button type="button" class="nav-item" data-tab="settings" onclick="switchTab('settings')">
            <i data-lucide="settings"></i>
            <span>Settings</span>
          </button>
        </nav>

        <div class="sidebar-footer">
          <div class="gateway-status">
            <div id="gateway-indicator" class="status-dot offline"></div>
            <span id="gateway-text">Gateway: Checking...</span>
          </div>
        </div>
      </aside>

      <!-- Sidebar Overlay -->
      <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Header -->
        <header class="header">
          <div class="header-left">
            <button type="button" class="menu-toggle" onclick="toggleSidebar()">
              <i data-lucide="menu"></i>
            </button>
            <div class="header-title">
              <h1 id="app-title">Smart School Monitor</h1>
              <p id="app-subtitle">SNMP Network Monitoring System</p>
            </div>
          </div>
          <div class="header-right">
            <button type="button" class="btn btn-primary btn-sm" onclick="refreshData()">
              <i data-lucide="refresh-cw"></i>
              <span>Refresh</span>
            </button>
            <div class="theme-toggle">
              <button type="button" class="theme-btn" data-theme="light" onclick="setTheme('light')">
                <i data-lucide="sun"></i>
              </button>
              <button type="button" class="theme-btn" data-theme="dark" onclick="setTheme('dark')">
                <i data-lucide="moon"></i>
              </button>
              <button type="button" class="theme-btn active" data-theme="system" onclick="setTheme('system')">
                <i data-lucide="monitor"></i>
              </button>
            </div>
          </div>
        </header>

        <!-- Tab Content -->
        <div class="content-area">
          <!-- Blueprint Tab -->
          <div id="tab-blueprint" class="tab-content active">
            <!-- Combined Map Toolbar -->
            <div class="map-toolbar" id="map-toolbar">
              <!-- Device Type Dropdown -->
              <div class="device-type-dropdown-wrapper">
                <button type="button" class="device-type-dropdown-btn" onclick="toggleDeviceTypeDropdown()" id="device-type-dropdown-btn">
                  <span class="dropdown-icon-wrapper"><i data-lucide="layers"></i></span>
                  <span id="active-device-type-name">All Devices</span>
                  <span class="device-type-count" id="active-device-type-count">0</span>
                  <span class="chevron-wrapper"><i data-lucide="chevron-down"></i></span>
                </button>
                <div class="device-type-dropdown-menu" id="device-type-dropdown-menu">
                  <!-- Populated dynamically by JavaScript -->
                </div>
              </div>

              <!-- Blueprint/Map Selector -->
              <div class="blueprint-dropdown-wrapper">
                <button type="button" class="blueprint-dropdown-btn" onclick="toggleBlueprintDropdown()">
                  <span class="dropdown-icon-wrapper"><i data-lucide="map-pin"></i></span>
                  <span id="active-blueprint-name">Blueprint 1</span>
                  <span class="chevron-wrapper"><i data-lucide="chevron-down"></i></span>
                </button>
                <div class="blueprint-dropdown-menu" id="blueprint-dropdown-menu">
                  <!-- Populated dynamically -->
                </div>
              </div>

              <!-- Map Actions -->
              <div class="map-toolbar-actions">
                <button type="button" class="btn btn-icon" onclick="togglePlaceMode()" id="place-device-btn" title="Place device on map">
                  <i data-lucide="crosshair"></i>
                </button>
                <button type="button" class="btn btn-outline btn-sm" onclick="addNewBlueprint()" title="Add new map">
                  <i data-lucide="plus"></i> Add
                </button>
                <button type="button" class="btn btn-outline btn-sm" onclick="uploadBlueprint()" title="Upload image">
                  <i data-lucide="upload"></i> Upload
                </button>
                <button type="button" class="btn btn-outline btn-sm" onclick="uploadCurrentBlueprintToCloud()" title="Save this map to cloud (for phone access)">
                  <i data-lucide="cloud-upload"></i> Cloud
                </button>
                <button type="button" class="btn btn-icon" onclick="showRenameBlueprintModal()" title="Rename blueprint">
                  <i data-lucide="edit-2"></i>
                </button>
                <button type="button" class="btn btn-icon btn-danger" onclick="deleteCurrentBlueprint()" id="delete-blueprint-btn" title="Delete map">
                  <i data-lucide="trash-2"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline" onclick="showManageDeviceTypesModal()" title="Manage Device Types">
                  <i data-lucide="settings"></i>
                </button>
              </div>
            </div>

            <!-- Blueprint Canvas -->
            <div class="blueprint-container-wrap" style="position: relative;">
            <div class="blueprint-container">
              <div id="blueprint-canvas" class="blueprint-canvas">
                <div id="blueprint-wrapper" class="blueprint-wrapper">
                  <img id="blueprint-image" src="" alt="Floor Plan" class="hidden">
                  <div id="device-markers" class="device-markers"></div>
                </div>
                <div id="tap-indicator" class="tap-indicator hidden"></div>
                <div class="no-blueprint" id="no-blueprint">
                  <i data-lucide="image"></i>
                  <p>No blueprint uploaded</p>
                  <button type="button" class="btn btn-primary" onclick="uploadBlueprint()">
                    <i data-lucide="upload"></i> Upload Blueprint
                  </button>
                </div>
              </div>

              <!-- Zoom Controls -->
              <div class="zoom-controls">
                <button type="button" class="zoom-btn" onclick="zoomIn()">
                  <i data-lucide="plus"></i>
                </button>
                <span id="zoom-level">100%</span>
                <button type="button" class="zoom-btn" onclick="zoomOut()">
                  <i data-lucide="minus"></i>
                </button>
                <button type="button" class="zoom-btn" onclick="resetZoom()">
                  <i data-lucide="maximize-2"></i>
                </button>
              </div>

              <!-- Map Background Color -->
              <div class="map-bg-color-picker">
                <label title="Custom Color">
                  <i data-lucide="palette"></i>
                  <input type="color" id="map-bg-color" value="#f8fafc" onchange="changeMapBackgroundColor(this.value)" title="Pick custom color">
                </label>
                <div class="map-bg-divider"></div>
                <div class="map-bg-presets">
                  <button type="button" class="map-bg-preset" style="background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);" onclick="changeMapBackgroundColor('#ffffff')" title="White" data-color="#ffffff"></button>
                  <button type="button" class="map-bg-preset" style="background: linear-gradient(135deg, #f8fafc 0%, #e8ecf0 100%);" onclick="changeMapBackgroundColor('#f8fafc')" title="Light Gray" data-color="#f8fafc"></button>
                  <button type="button" class="map-bg-preset" style="background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);" onclick="changeMapBackgroundColor('#e2e8f0')" title="Gray" data-color="#e2e8f0"></button>
                  <button type="button" class="map-bg-preset" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);" onclick="changeMapBackgroundColor('#1e293b')" title="Dark" data-color="#1e293b"></button>
                  <button type="button" class="map-bg-preset" style="background: linear-gradient(135deg, #0f172a 0%, #020617 100%);" onclick="changeMapBackgroundColor('#0f172a')" title="Black" data-color="#0f172a"></button>
                </div>
              </div>
            </div>
            <!-- Alert Tooltip Overlay (outside blueprint-container to avoid overflow clipping) -->
            <div id="alert-tooltip-overlay" class="alert-tooltip-overlay"></div>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
              <div class="stat-card stat-online">
                <div class="stat-icon"><i data-lucide="check-circle"></i></div>
                <div class="stat-info">
                  <span class="stat-value" id="stat-online">0</span>
                  <span class="stat-label">Online</span>
                </div>
              </div>
              <div class="stat-card stat-offline">
                <div class="stat-icon"><i data-lucide="x-circle"></i></div>
                <div class="stat-info">
                  <span class="stat-value" id="stat-offline">0</span>
                  <span class="stat-label">Offline</span>
                </div>
              </div>
              <div class="stat-card stat-issue">
                <div class="stat-icon"><i data-lucide="alert-triangle"></i></div>
                <div class="stat-info">
                  <span class="stat-value" id="stat-issues">0</span>
                  <span class="stat-label">Issues</span>
                </div>
              </div>
              <div class="stat-card stat-traps">
                <div class="stat-icon"><i data-lucide="bell"></i></div>
                <div class="stat-info">
                  <span class="stat-value" id="stat-traps">0</span>
                  <span class="stat-label">Traps</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Dashboard Tab -->
          <div id="tab-dashboard" class="tab-content">
            <!-- View Mode Toggle -->
            <div class="dashboard-view-toggle">
              <span class="view-label">View:</span>
              <div class="view-toggle-group">
                <button type="button" class="view-btn active" data-view="overview" onclick="setDashboardView('overview')">
                  <i data-lucide="layout-grid"></i> Overview
                </button>
                <button type="button" class="view-btn" data-view="cards" onclick="setDashboardView('cards')">
                  <i data-lucide="square"></i> Cards
                </button>
                <button type="button" class="view-btn" data-view="gauges" onclick="setDashboardView('gauges')">
                  <i data-lucide="gauge"></i> Gauges
                </button>
              </div>
            </div>

            <div class="dashboard-grid" id="dashboard-content">
              <!-- Overview Cards -->
              <div class="dashboard-section" id="overview-section">
                <h2 class="section-title">Overview</h2>
                <div class="overview-cards">
                  <div class="overview-card">
                    <div class="ring-progress" data-percent="0" id="ring-online">
                      <svg viewBox="0 0 100 100">
                        <circle class="ring-bg" cx="50" cy="50" r="45"/>
                        <circle class="ring-fill" cx="50" cy="50" r="45" stroke="#22c55e"/>
                      </svg>
                      <div class="ring-content">
                        <span class="ring-value">0</span>
                        <span class="ring-total">/0</span>
                      </div>
                    </div>
                    <span class="overview-label">Online</span>
                  </div>
                  <div class="overview-card">
                    <div class="ring-progress" data-percent="0" id="ring-offline">
                      <svg viewBox="0 0 100 100">
                        <circle class="ring-bg" cx="50" cy="50" r="45"/>
                        <circle class="ring-fill" cx="50" cy="50" r="45" stroke="#6b7280"/>
                      </svg>
                      <div class="ring-content">
                        <span class="ring-value">0</span>
                        <span class="ring-total">/0</span>
                      </div>
                    </div>
                    <span class="overview-label">Offline</span>
                  </div>
                  <div class="overview-card">
                    <div class="ring-progress" data-percent="0" id="ring-issues">
                      <svg viewBox="0 0 100 100">
                        <circle class="ring-bg" cx="50" cy="50" r="45"/>
                        <circle class="ring-fill" cx="50" cy="50" r="45" stroke="#f59e0b"/>
                      </svg>
                      <div class="ring-content">
                        <span class="ring-value">0</span>
                        <span class="ring-total">/0</span>
                      </div>
                    </div>
                    <span class="overview-label">Issues</span>
                  </div>
                  <div class="overview-card">
                    <div class="ring-progress" data-percent="0" id="ring-traps">
                      <svg viewBox="0 0 100 100">
                        <circle class="ring-bg" cx="50" cy="50" r="45"/>
                        <circle class="ring-fill" cx="50" cy="50" r="45" stroke="#ef4444"/>
                      </svg>
                      <div class="ring-content">
                        <span class="ring-value">0</span>
                        <span class="ring-total">/0</span>
                      </div>
                    </div>
                    <span class="overview-label">Active Traps</span>
                  </div>
                </div>
              </div>

              <!-- Active Alerts / Service Requests Section -->
              <div class="dashboard-section alerts-section">
                <div class="section-header">
                  <h2 class="section-title"><i data-lucide="alert-triangle"></i> Active Alerts</h2>
                  <div class="section-actions">
                    <button type="button" class="btn btn-ghost btn-sm" onclick="loadServiceRequests(); loadAlertCards();">
                      <i data-lucide="refresh-cw"></i>
                    </button>
                    <button type="button" class="btn btn-ghost btn-sm" onclick="switchTab('requests')">View All</button>
                  </div>
                </div>
                <div id="alert-cards-container" class="alert-cards-container">
                  <div class="empty-state">
                    <i data-lucide="check-circle"></i>
                    <p>No pending alerts</p>
                  </div>
                </div>
              </div>

              <!-- Device List with Supplies -->
              <div class="dashboard-section">
                <h2 class="section-title">Device Supply Levels</h2>
                <div id="device-supply-list" class="device-supply-list">
                  <div class="empty-state">
                    <i data-lucide="printer"></i>
                    <p>No devices with supply data</p>
                  </div>
                </div>
              </div>

              <!-- Recent Traps -->
              <div class="dashboard-section">
                <div class="section-header">
                  <h2 class="section-title">Recent SNMP Traps</h2>
                  <button type="button" class="btn btn-ghost btn-sm" onclick="switchTab('traps')">View All</button>
                </div>
                <div id="recent-traps" class="recent-traps">
                  <div class="empty-state">
                    <i data-lucide="bell-off"></i>
                    <p>No recent traps</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Overview Tab - Modern Dashboard -->
          <div id="tab-overview" class="tab-content">
            <div class="overview-dashboard">
              <!-- Top Header Row -->
              <div class="od-header">
                <div class="od-search-bar">
                  <i data-lucide="search"></i>
                  <input type="text" placeholder="Quick search devices, requests..." id="od-search-input">
                </div>
                <div class="od-header-actions">
                  <button type="button" class="od-icon-btn" onclick="loadOverviewDashboard(true)" title="Refresh">
                    <i data-lucide="refresh-cw"></i>
                  </button>
                  <div class="od-user-profile">
                    <span class="od-user-name">Admin</span>
                    <div class="od-user-avatar">
                      <i data-lucide="user"></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Main Content Grid -->
              <div class="od-main-grid">
                <!-- Left Column -->
                <div class="od-left-column">
                  <!-- Balance/Total Overview Card -->
                  <div class="od-card od-main-stat">
                    <div class="od-stat-header">
                      <div class="od-stat-info">
                        <span class="od-stat-value" id="od-total-devices">0</span>
                        <span class="od-stat-label">Total Devices</span>
                      </div>
                      <div class="od-stat-toggle">
                        <select id="od-time-range" onchange="updateOverviewStats()">
                          <option value="7d">7d</option>
                          <option value="30d">30d</option>
                          <option value="90d">90d</option>
                        </select>
                        <div class="od-chart-type-btns">
                          <button type="button" class="active" onclick="setOverviewChartType('bar', event)"><i data-lucide="bar-chart-3"></i></button>
                          <button type="button" onclick="setOverviewChartType('line', event)"><i data-lucide="trending-up"></i></button>
                        </div>
                      </div>
                    </div>
                    <div class="od-chart-legend">
                      <span class="od-legend-item"><span class="od-dot" style="background:#86efac"></span> Online</span>
                      <span class="od-legend-item"><span class="od-dot" style="background:#fde68a"></span> Warning</span>
                      <span class="od-legend-item"><span class="od-dot" style="background:#fca5a5"></span> Offline</span>
                    </div>
                    <div class="od-chart-container" id="od-main-chart">
                      <!-- Bar chart will be rendered here -->
                      <div class="od-bar-chart">
                        <div class="od-bar-group" data-day="Sun">
                          <div class="od-bar od-bar-online" style="height: 60%"></div>
                          <div class="od-bar od-bar-warning" style="height: 20%"></div>
                          <div class="od-bar od-bar-offline" style="height: 10%"></div>
                        </div>
                        <div class="od-bar-group" data-day="Mon">
                          <div class="od-bar od-bar-online" style="height: 70%"></div>
                          <div class="od-bar od-bar-warning" style="height: 15%"></div>
                          <div class="od-bar od-bar-offline" style="height: 8%"></div>
                        </div>
                        <div class="od-bar-group" data-day="Tue">
                          <div class="od-bar od-bar-online" style="height: 65%"></div>
                          <div class="od-bar od-bar-warning" style="height: 25%"></div>
                          <div class="od-bar od-bar-offline" style="height: 5%"></div>
                        </div>
                        <div class="od-bar-group" data-day="Wed">
                          <div class="od-bar od-bar-online" style="height: 80%"></div>
                          <div class="od-bar od-bar-warning" style="height: 10%"></div>
                          <div class="od-bar od-bar-offline" style="height: 5%"></div>
                        </div>
                        <div class="od-bar-group" data-day="Thu">
                          <div class="od-bar od-bar-online" style="height: 75%"></div>
                          <div class="od-bar od-bar-warning" style="height: 12%"></div>
                          <div class="od-bar od-bar-offline" style="height: 8%"></div>
                        </div>
                        <div class="od-bar-group" data-day="Fri">
                          <div class="od-bar od-bar-online" style="height: 85%"></div>
                          <div class="od-bar od-bar-warning" style="height: 8%"></div>
                          <div class="od-bar od-bar-offline" style="height: 5%"></div>
                        </div>
                        <div class="od-bar-group" data-day="Sat">
                          <div class="od-bar od-bar-online" style="height: 50%"></div>
                          <div class="od-bar od-bar-warning" style="height: 10%"></div>
                          <div class="od-bar od-bar-offline" style="height: 5%"></div>
                        </div>
                      </div>
                      <div class="od-chart-labels">
                        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                      </div>
                    </div>
                  </div>

                  <!-- Stats Row -->
                  <div class="od-stats-row">
                    <div class="od-mini-stat">
                      <span class="od-mini-label">Online Devices</span>
                      <span class="od-mini-value" id="od-online-count">0</span>
                      <span class="od-mini-change positive"><i data-lucide="trending-up"></i> 5.1% from last week</span>
                    </div>
                    <div class="od-mini-stat">
                      <span class="od-mini-label">Active Issues</span>
                      <span class="od-mini-value" id="od-issues-count">0</span>
                      <span class="od-mini-change negative"><i data-lucide="trending-down"></i> 15.5% from last week</span>
                    </div>
                    <div class="od-mini-stat">
                      <span class="od-mini-label">Resolved Today</span>
                      <span class="od-mini-value" id="od-resolved-count">0</span>
                      <span class="od-mini-change positive"><i data-lucide="trending-up"></i> 20.7% from last week</span>
                    </div>
                  </div>

                  <!-- Monthly Limit / Supply Warning -->
                  <div class="od-card od-progress-card">
                    <div class="od-progress-header">
                      <span class="od-progress-title">Low Supply Devices</span>
                      <button type="button" class="od-edit-btn" onclick="editLowSupplyThreshold()" title="Edit threshold"><i data-lucide="pencil"></i></button>
                    </div>
                    <div class="od-progress-bar-container">
                      <div class="od-progress-bar">
                        <div class="od-progress-fill" id="od-low-supply-bar" style="width: 35%"></div>
                      </div>
                      <div class="od-progress-labels">
                        <span id="od-low-supply-count">3</span>
                        <span id="od-total-supply-count">15</span>
                      </div>
                    </div>
                  </div>

                  <!-- Quick Tips -->
                  <div class="od-card od-tips-card">
                    <h4>Optimize your workflow with these quick tips</h4>
                    <p>Start preparing for the end of month by checking low toner devices and scheduling maintenance.</p>
                    <a href="#" onclick="switchTab('devices'); return false;">Read more <i data-lucide="chevron-right"></i></a>
                  </div>

                  <!-- Bottom Stats Row -->
                  <div class="od-bottom-stats">
                    <!-- Cost Analysis -->
                    <div class="od-card od-analysis-card">
                      <div class="od-analysis-header">
                        <h4>Device Analysis</h4>
                        <select>
                          <option>This Month</option>
                          <option>Last Month</option>
                        </select>
                      </div>
                      <span class="od-analysis-value" id="od-device-analysis">24</span>
                      <span class="od-analysis-subtitle">Devices monitored</span>
                      <div class="od-breakdown-list" id="od-device-breakdown">
                        <div class="od-breakdown-item">
                          <span class="od-breakdown-dot" style="background:#86efac"></span>
                          <span class="od-breakdown-label">Printers</span>
                          <span class="od-breakdown-value">45%</span>
                        </div>
                        <div class="od-breakdown-item">
                          <span class="od-breakdown-dot" style="background:#93c5fd"></span>
                          <span class="od-breakdown-label">Copiers</span>
                          <span class="od-breakdown-value">30%</span>
                        </div>
                        <div class="od-breakdown-item">
                          <span class="od-breakdown-dot" style="background:#fde68a"></span>
                          <span class="od-breakdown-label">MFPs</span>
                          <span class="od-breakdown-value">20%</span>
                        </div>
                        <div class="od-breakdown-item">
                          <span class="od-breakdown-dot" style="background:#d8b4fe"></span>
                          <span class="od-breakdown-label">Other</span>
                          <span class="od-breakdown-value">5%</span>
                        </div>
                      </div>
                    </div>

                    <!-- Health Score -->
                    <div class="od-card od-health-card">
                      <div class="od-analysis-header">
                        <h4>System Health</h4>
                        <select>
                          <option>30d</option>
                          <option>7d</option>
                        </select>
                      </div>
                      <span class="od-analysis-value" id="od-health-score">92%</span>
                      <span class="od-analysis-subtitle positive"><i data-lucide="trending-up"></i> 17.5% from last month</span>
                      <div class="od-donut-container">
                        <svg class="od-donut" viewBox="0 0 100 100">
                          <circle class="od-donut-bg" cx="50" cy="50" r="40"/>
                          <circle class="od-donut-fill" cx="50" cy="50" r="40" stroke-dasharray="226.2" stroke-dashoffset="56.5"/>
                        </svg>
                        <div class="od-donut-label">
                          <span class="od-donut-value">75%</span>
                          <span class="od-donut-text">Uptime</span>
                        </div>
                      </div>
                      <p class="od-health-note">Based on aggregated device metrics over the past 30 days</p>
                    </div>

                    <!-- Goal Tracker -->
                    <div class="od-card od-goals-card">
                      <div class="od-analysis-header">
                        <h4>Goal Tracker</h4>
                        <button type="button" class="btn btn-outline btn-sm" onclick="showAddGoalModal()">+ Add goals</button>
                      </div>
                      <div class="od-goals-list">
                        <div class="od-goal-section">
                          <span class="od-goal-period">This Month</span>
                          <div class="od-goal-item">
                            <div class="od-goal-icon" style="background:#fef3c7"><i data-lucide="target"></i></div>
                            <div class="od-goal-info">
                              <span class="od-goal-name">Zero Downtime</span>
                              <span class="od-goal-progress-text">18/30 days</span>
                            </div>
                            <div class="od-goal-bar">
                              <div class="od-goal-fill" style="width: 60%; background: #fbbf24"></div>
                            </div>
                          </div>
                        </div>
                        <div class="od-goal-section">
                          <span class="od-goal-period">Long Term</span>
                          <div class="od-goal-item">
                            <div class="od-goal-icon" style="background:#dbeafe"><i data-lucide="wrench"></i></div>
                            <div class="od-goal-info">
                              <span class="od-goal-name">Maintenance</span>
                              <span class="od-goal-progress-text">12/20 devices</span>
                            </div>
                            <div class="od-goal-bar">
                              <div class="od-goal-fill" style="width: 60%; background: #3b82f6"></div>
                            </div>
                          </div>
                          <div class="od-goal-item">
                            <div class="od-goal-icon" style="background:#dcfce7"><i data-lucide="check-circle"></i></div>
                            <div class="od-goal-info">
                              <span class="od-goal-name">All Online</span>
                              <span class="od-goal-progress-text">22/24 devices</span>
                            </div>
                            <div class="od-goal-bar">
                              <div class="od-goal-fill" style="width: 92%; background: #22c55e"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Right Column -->
                <div class="od-right-column">
                  <!-- Quick Actions Card -->
                  <div class="od-card od-actions-card">
                    <div class="od-actions-header">
                      <h4>Quick Actions</h4>
                      <button type="button" class="btn btn-outline btn-sm" onclick="showAddQuickAction()">+ Add</button>
                    </div>
                    <div class="od-device-preview">
                      <div class="od-device-card active">
                        <span class="od-device-type">Main Printer</span>
                        <div class="od-device-details">
                          <span class="od-device-id">PR-001</span>
                          <span class="od-device-status online">Online</span>
                        </div>
                      </div>
                    </div>
                    <div class="od-quick-btns">
                      <button type="button" class="od-quick-btn" onclick="switchTab('devices')">
                        <i data-lucide="printer"></i>
                        <span>Devices</span>
                      </button>
                      <button type="button" class="od-quick-btn" onclick="switchTab('requests')">
                        <i data-lucide="send"></i>
                        <span>Requests</span>
                      </button>
                      <button type="button" class="od-quick-btn" onclick="switchTab('traps')">
                        <i data-lucide="bell"></i>
                        <span>Alerts</span>
                      </button>
                      <button type="button" class="od-quick-btn" onclick="switchTab('analytics')">
                        <i data-lucide="clock"></i>
                        <span>History</span>
                      </button>
                      <button type="button" class="od-quick-btn" onclick="switchTab('settings')">
                        <i data-lucide="more-horizontal"></i>
                        <span>More</span>
                      </button>
                    </div>
                  </div>

                  <!-- Quick Access Devices -->
                  <div class="od-card od-quick-devices">
                    <div class="od-actions-header">
                      <h4>Quick Access</h4>
                      <button type="button" class="od-more-btn" onclick="showOverviewMoreMenu(event)" title="More options"><i data-lucide="more-vertical"></i></button>
                    </div>
                    <div class="od-device-avatars" id="od-quick-device-list">
                      <!-- Populated by JS -->
                    </div>
                  </div>

                  <!-- Recent Activity / Transaction History -->
                  <div class="od-card od-activity-card">
                    <div class="od-actions-header">
                      <h4>Recent Activity</h4>
                      <select id="od-activity-range">
                        <option value="7d">7d</option>
                        <option value="30d">30d</option>
                      </select>
                    </div>
                    <div class="od-activity-list" id="od-activity-list">
                      <!-- Activity items populated by JS -->
                      <div class="od-activity-item">
                        <div class="od-activity-icon" style="background: #dcfce7; color: #16a34a">
                          <i data-lucide="check"></i>
                        </div>
                        <div class="od-activity-info">
                          <span class="od-activity-title">Device Online</span>
                          <span class="od-activity-date">Just now</span>
                        </div>
                        <span class="od-activity-status success">Resolved</span>
                      </div>
                      <div class="od-activity-item">
                        <div class="od-activity-icon" style="background: #fef3c7; color: #d97706">
                          <i data-lucide="alert-triangle"></i>
                        </div>
                        <div class="od-activity-info">
                          <span class="od-activity-title">Low Toner Warning</span>
                          <span class="od-activity-date">2 hours ago</span>
                        </div>
                        <span class="od-activity-status warning">Pending</span>
                      </div>
                      <div class="od-activity-item">
                        <div class="od-activity-icon" style="background: #dbeafe; color: #2563eb">
                          <i data-lucide="wrench"></i>
                        </div>
                        <div class="od-activity-info">
                          <span class="od-activity-title">Maintenance Complete</span>
                          <span class="od-activity-date">Yesterday</span>
                        </div>
                        <span class="od-activity-status success">Completed</span>
                      </div>
                      <div class="od-activity-item">
                        <div class="od-activity-icon" style="background: #fee2e2; color: #dc2626">
                          <i data-lucide="x-circle"></i>
                        </div>
                        <div class="od-activity-info">
                          <span class="od-activity-title">Paper Jam Reported</span>
                          <span class="od-activity-date">2 days ago</span>
                        </div>
                        <span class="od-activity-status danger">Critical</span>
                      </div>
                      <div class="od-activity-item">
                        <div class="od-activity-icon" style="background: #f3e8ff; color: #9333ea">
                          <i data-lucide="package"></i>
                        </div>
                        <div class="od-activity-info">
                          <span class="od-activity-title">Supplies Ordered</span>
                          <span class="od-activity-date">3 days ago</span>
                        </div>
                        <span class="od-activity-status success">Completed</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Devices Tab -->
          <div id="tab-devices" class="tab-content">
            <div class="devices-header">
              <h2 class="section-title">Manage Devices</h2>
              <div class="devices-toolbar">
                <button type="button" class="btn btn-outline btn-sm" onclick="exportSheetCSV('Devices')" title="Export all devices as CSV">
                  <i data-lucide="download"></i> Export CSV
                </button>
                <button type="button" class="btn btn-outline btn-sm" onclick="showDeviceImportModal()" title="Import devices from CSV">
                  <i data-lucide="upload"></i> Import CSV
                </button>
                <button type="button" class="btn btn-danger btn-sm" onclick="confirmClearDevices()" title="Delete all devices">
                  <i data-lucide="trash-2"></i> Delete All
                </button>
                <button type="button" class="btn btn-primary btn-sm" onclick="showAddDeviceModal()">
                  <i data-lucide="plus"></i> Add Device
                </button>
              </div>
            </div>

            <!-- Search and Filter -->
            <div style="margin-bottom: 16px;">
              <div class="search-input-wrapper">
                <i data-lucide="search"></i>
                <input type="text" id="devices-search" placeholder="Search by name, IP, model, machine ID, location..." oninput="filterDevices()">
              </div>
            </div>

            <div class="devices-table-container">
              <table class="devices-table">
                <thead>
                  <tr>
                    <th>Status</th>
                    <th>Name</th>
                    <th>IP Address</th>
                    <th>Model</th>
                    <th>Machine ID</th>
                    <th>Serial Number</th>
                    <th>Location</th>
                    <th>Last Seen</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="devices-table-body">
                  <tr class="empty-row">
                    <td colspan="9">
                      <div class="empty-state">
                        <i data-lucide="printer"></i>
                        <p>No devices added yet</p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Traps Tab -->
          <div id="tab-traps" class="tab-content">
            <div class="traps-header">
              <h2 class="section-title">SNMP Traps</h2>
              <div class="traps-actions">
                <label class="toggle-label">
                  <input type="checkbox" id="audio-alerts" checked onchange="toggleAudioAlerts()">
                  <span class="toggle-slider"></span>
                  <span>üîî Sound</span>
                </label>
                <label class="toggle-label" title="When ON, automatically checks for new traps every 5 seconds. When OFF, use the Refresh button manually.">
                  <input type="checkbox" id="auto-refresh-traps" onchange="toggleTrapAutoRefresh()">
                  <span class="toggle-slider"></span>
                  <span id="polling-status-text">Auto-Refresh OFF</span>
                </label>
                <button type="button" class="btn btn-primary btn-sm" onclick="manualRefreshTraps()">
                  <i data-lucide="refresh-cw"></i> Refresh
                </button>
                <button type="button" class="btn btn-outline btn-sm" onclick="testAlertSound()">
                  <i data-lucide="volume-2"></i> Test Sound
                </button>
                <button type="button" class="btn btn-danger btn-sm" onclick="clearAllTraps()">
                  <i data-lucide="trash-2"></i> Clear All
                </button>
              </div>
            </div>

            <div id="traps-list" class="traps-list">
              <div class="empty-state">
                <i data-lucide="bell-off"></i>
                <p>No SNMP traps received</p>
              </div>
            </div>
          </div>

          <!-- Service Requests Tab -->
          <div id="tab-requests" class="tab-content">
            <div class="requests-content">
              <div class="requests-stats">
                <div class="stat-card stat-pending">
                  <span class="stat-value" id="sr-stat-pending">0</span>
                  <span class="stat-label">Pending</span>
                </div>
                <div class="stat-card stat-in-progress">
                  <span class="stat-value" id="sr-stat-in-progress">0</span>
                  <span class="stat-label">In Progress</span>
                </div>
                <div class="stat-card stat-completed">
                  <span class="stat-value" id="sr-stat-completed">0</span>
                  <span class="stat-label">Completed</span>
                </div>
              </div>

              <div class="requests-header">
                <h2 class="section-title">Service Requests</h2>
                <div class="requests-actions">
                  <div class="filter-controls">
                    <label for="sr-filter-status">Filter:</label>
                    <select id="sr-filter-status" class="form-select" onchange="filterServiceRequests()">
                      <option value="">All</option>
                      <option value="pending">Pending</option>
                      <option value="in-progress">In Progress</option>
                      <option value="completed">Completed</option>
                    </select>
                    <select id="sr-filter-source" class="form-select" onchange="filterServiceRequests()" style="margin-left:6px;">
                      <option value="">All Sources</option>
                      <option value="qr">QR Scan</option>
                      <option value="helpdesk">Help Desk</option>
                    </select>
                  </div>
                  <div class="requests-buttons">
                    <button type="button" class="btn btn-outline btn-sm" onclick="exportServiceRequests()">
                      <i data-lucide="download"></i> Export CSV
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteAllServiceRequests()">
                      <i data-lucide="trash-2"></i> Delete All
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="loadServiceRequests()">
                      <i data-lucide="refresh-cw"></i> Refresh
                    </button>
                  </div>
                </div>
              </div>

              <div class="requests-table-container">
                <table class="requests-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Source</th>
                      <th>Requester</th>
                      <th>Location</th>
                      <th>Issue</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="service-requests-table-body">
                    <tr>
                      <td colspan="7" class="empty-message">Loading service requests...</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Sent Email Log -->
              <div class="email-log-section" style="margin-top:24px;">
                <div class="email-log-header" onclick="toggleEmailLog()" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between; padding:12px 0;">
                  <h3 style="display:flex; align-items:center; gap:8px; font-size:16px; margin:0;">
                    <i data-lucide="mail"></i> Sent Email Log
                  </h3>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <span id="email-log-count" class="data-mgmt-badge" style="font-size:11px;">0</span>
                    <i data-lucide="chevron-down" id="email-log-chevron" style="width:18px;height:18px;transition:transform 0.2s;"></i>
                  </div>
                </div>
                <div id="email-log-body" style="display:none;">
                  <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
                    <button type="button" class="btn btn-sm btn-outline" onclick="exportEmailLog()">
                      <i data-lucide="download"></i> Export CSV
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteAllEmailLog()">
                      <i data-lucide="trash-2"></i> Delete All
                    </button>
                  </div>
                  <div class="requests-table-container">
                    <table class="requests-table">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>To</th>
                          <th>CC</th>
                          <th>Subject</th>
                          <th>Status</th>
                          <th style="text-align:center;">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="email-log-table-body">
                        <tr><td colspan="6" class="empty-message">Loading...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Email Tab -->
          <div id="tab-email" class="tab-content">
            <div class="settings-section">
              <h2 class="section-title">Email Configuration</h2>
              <p class="section-desc">Configure email notifications for device alerts</p>

              <form id="email-form" class="settings-form" onsubmit="saveEmailSettings(event)">
                <div class="form-group">
                  <label for="company-email">Company Email (Recipient)</label>
                  <input type="email" id="company-email" placeholder="support@yourschool.com">
                </div>

                <div class="form-group">
                  <label for="email-subject">Email Subject</label>
                  <input type="text" id="email-subject" placeholder="Printer Issue Report">
                </div>

                <div class="form-group">
                  <label for="email-template">Email Template</label>
                  <textarea id="email-template" rows="6" placeholder="Dear Support Team,&#10;&#10;{PRINTER_INFO}&#10;&#10;Thank you."></textarea>
                  <small class="form-hint">Available placeholders: {PRINTER_INFO}, {DEVICE_NAME}, {DEVICE_IP}, {DEVICE_LOCATION}, {TIMESTAMP}</small>
                </div>

                <div class="form-actions">
                  <button type="submit" class="btn btn-primary">
                    <i data-lucide="save"></i> Save Settings
                  </button>
                  <button type="button" class="btn btn-outline" onclick="testEmail()">
                    <i data-lucide="send"></i> Send Test Email
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Help Desk Tab -->
          <div id="tab-helpdesk" class="tab-content">
            <div class="helpdesk-container">
              <div class="helpdesk-header">
                <h2><i data-lucide="headphones"></i> Help Desk ‚Äî Create Incident</h2>
              </div>

              <!-- ServiceNow Site Config -->
              <div class="helpdesk-config">
                <label for="helpdesk-site-number">Site Number</label>
                <input type="text" id="helpdesk-site-number" placeholder="e.g. 1681" style="width:80px;" />
                <button type="button" class="btn btn-sm" onclick="saveHelpdeskSiteNumber()">Save</button>
                <span id="helpdesk-site-status" style="margin-left:8px; font-size:12px; color:#888;"></span>
              </div>

              <div class="helpdesk-form">
                <!-- Step 1: Employee Lookup -->
                <div class="helpdesk-step">
                  <div class="step-header">
                    <span class="step-number">1</span>
                    <h3>Employee Lookup</h3>
                  </div>
                  <div class="step-content">
                    <div class="helpdesk-input-row">
                      <label for="helpdesk-emp-id">Employee ID</label>
                      <div class="helpdesk-input-group">
                        <input type="text" id="helpdesk-emp-id" placeholder="Enter employee ID..." />
                        <button type="button" class="btn btn-primary btn-sm" onclick="lookupHelpdeskEmployee()">
                          <i data-lucide="search"></i> Look Up
                        </button>
                      </div>
                    </div>
                    <div id="helpdesk-employee-result" class="employee-lookup-result hidden">
                      <div class="employee-found">
                        <i data-lucide="check-circle" class="employee-check-icon"></i>
                        <div class="employee-info">
                          <span id="helpdesk-emp-name" class="emp-name"></span>
                          <span id="helpdesk-emp-details" class="emp-details"></span>
                        </div>
                      </div>
                    </div>
                    <div id="helpdesk-employee-error" class="employee-lookup-error hidden">
                      <i data-lucide="alert-circle"></i>
                      <span>Employee not found. Check the ID and try again.</span>
                    </div>
                  </div>
                </div>

                <!-- Step 2: AI Description -->
                <div class="helpdesk-step">
                  <div class="step-header">
                    <span class="step-number ai-step-number">2</span>
                    <h3>Describe the Issue</h3>
                  </div>
                  <div class="step-content">
                    <div class="helpdesk-input-row">
                      <label for="helpdesk-ai-input">Describe the problem in your own words:</label>
                      <textarea id="helpdesk-ai-input" rows="3" placeholder="e.g. teacher called, printer in room 204 has a paper jam and wont print..."></textarea>
                    </div>
                    <div id="ai-spinner" style="display:none; padding:8px 0; color:#7c3aed;">
                      <i data-lucide="loader" style="width:16px;height:16px;display:inline-block;animation:spin 1s linear infinite;"></i>
                      Analyzing...
                    </div>
                    <div id="ai-suggestion-panel" class="ai-suggestion-panel" style="display:none;">
                      <div class="ai-suggestion-header">
                        <span class="ai-badge">AI Suggestion</span>
                        <span id="ai-confidence-badge" class="ai-confidence-badge">85%</span>
                        <span id="ai-source-badge" class="ai-source-badge">rules</span>
                      </div>
                      <div class="ai-suggestion-body">
                        <div class="ai-suggestion-row">
                          <span class="ai-label">Category:</span>
                          <span id="ai-suggest-category" class="ai-value"></span>
                          <button type="button" class="ai-accept-btn" onclick="acceptAiField('category')">Accept</button>
                        </div>
                        <div class="ai-suggestion-row">
                          <span class="ai-label">Subcategory:</span>
                          <span id="ai-suggest-subcategory" class="ai-value"></span>
                          <button type="button" class="ai-accept-btn" onclick="acceptAiField('subcategory')">Accept</button>
                        </div>
                        <div class="ai-suggestion-row">
                          <span class="ai-label">Channel:</span>
                          <span id="ai-suggest-channel" class="ai-value"></span>
                          <button type="button" class="ai-accept-btn" onclick="acceptAiField('channel')">Accept</button>
                        </div>
                        <div class="ai-suggestion-row">
                          <span class="ai-label">Impact:</span>
                          <span id="ai-suggest-impact" class="ai-value"></span>
                          <button type="button" class="ai-accept-btn" onclick="acceptAiField('impact')">Accept</button>
                        </div>
                        <div class="ai-suggestion-row">
                          <span class="ai-label">Service Offering:</span>
                          <span id="ai-suggest-service-offering" class="ai-value"></span>
                          <button type="button" class="ai-accept-btn" onclick="acceptAiField('serviceOffering')">Accept</button>
                        </div>
                        <div class="ai-suggestion-row ai-desc-row">
                          <span class="ai-label">Improved Description:</span>
                          <div id="ai-suggest-description" class="ai-improved-desc"></div>
                          <button type="button" class="ai-accept-btn" onclick="acceptAiField('description')">Accept</button>
                        </div>
                        <button type="button" class="ai-accept-all-btn" onclick="acceptAllAiSuggestions()">Accept All Suggestions</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Step 3: Issue Details -->
                <div class="helpdesk-step">
                  <div class="step-header">
                    <span class="step-number">3</span>
                    <h3>Issue Details</h3>
                  </div>
                  <div class="step-content">
                    <div class="helpdesk-input-row">
                      <label for="helpdesk-channel">Channel <span class="required-star">*</span></label>
                      <select id="helpdesk-channel">
                        <option value="">-- None --</option>
                        <option value="walk-in" selected>Walk-in</option>
                        <option value="phone">Phone</option>
                        <option value="email">Email</option>
                        <option value="self-service">Self-service</option>
                        <option value="chat">Chat</option>
                      </select>
                    </div>
                    <div class="helpdesk-two-col">
                      <div class="helpdesk-input-row">
                        <label for="helpdesk-category">Category <span class="required-star">*</span></label>
                        <select id="helpdesk-category" onchange="onHelpdeskCategoryChange()">
                          <option value="">-- None --</option>
                          <option value="Hardware">Hardware</option>
                          <option value="Network">Network</option>
                          <option value="Software">Software</option>
                        </select>
                      </div>
                      <div class="helpdesk-input-row">
                        <label for="helpdesk-subcategory">Subcategory <span class="required-star">*</span></label>
                        <select id="helpdesk-subcategory">
                          <option value="">-- Select Category first --</option>
                        </select>
                      </div>
                    </div>
                    <div class="helpdesk-two-col">
                      <div class="helpdesk-input-row">
                        <label for="helpdesk-impact">Impact</label>
                        <select id="helpdesk-impact">
                          <option value="4" selected>Individual</option>
                          <option value="3">Single School/Department</option>
                          <option value="2">Multiple Schools/Departments</option>
                          <option value="1">District</option>
                        </select>
                      </div>
                      <div class="helpdesk-input-row">
                        <label for="helpdesk-user-type">User Type</label>
                        <select id="helpdesk-user-type">
                          <option value="">-- None --</option>
                          <option value="school_staff">School Staff</option>
                          <option value="department_staff">Department Staff</option>
                          <option value="student">Student</option>
                          <option value="non-district person">Non-District Person</option>
                        </select>
                      </div>
                    </div>
                    <div class="helpdesk-input-row">
                      <label for="helpdesk-short-desc">Short Description <span class="required-star">*</span></label>
                      <input type="text" id="helpdesk-short-desc" placeholder="Brief summary of the issue..." maxlength="160" />
                    </div>
                    <div class="helpdesk-input-row">
                      <label for="helpdesk-full-desc">Description</label>
                      <textarea id="helpdesk-full-desc" rows="4" placeholder="Please provide any additional information about the issue..."></textarea>
                    </div>
                  </div>
                </div>

                <!-- Step 4: ServiceNow -->
                <div class="helpdesk-step">
                  <div class="step-header">
                    <span class="step-number">4</span>
                    <h3>ServiceNow</h3>
                  </div>
                  <div class="step-content">
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                      <button type="button" class="btn btn-secondary" onclick="openServiceNow()" id="helpdesk-open-sn-btn">
                        <i data-lucide="external-link"></i> Open ServiceNow (Pre-filled)
                      </button>
                    </div>
                    <div class="helpdesk-input-row" style="margin-top:12px;">
                      <label for="helpdesk-inc-number">Incident Number</label>
                      <input type="text" id="helpdesk-inc-number" placeholder="Auto-captured after submit" />
                      <span id="helpdesk-inc-status" style="font-size:12px; color:#888; margin-top:4px; display:block;"></span>
                    </div>
                  </div>
                </div>

                <!-- Step 5: Save & Notify -->
                <div class="helpdesk-step">
                  <div class="step-header">
                    <span class="step-number">5</span>
                    <h3>Save &amp; Notify</h3>
                  </div>
                  <div class="step-content">
                    <div class="incident-actions">
                      <button type="button" class="btn btn-primary" onclick="saveAndSendNow()">
                        <i data-lucide="send"></i> Save &amp; Send Email Now
                      </button>
                      <button type="button" class="btn btn-secondary" onclick="saveAndQueueEmail()">
                        <i data-lucide="clock"></i> Save &amp; Queue Email for Later
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Recent Incidents Table -->
              <div class="helpdesk-section">
                <div class="helpdesk-section-header">
                  <h3>Recent Incidents</h3>
                  <button type="button" class="btn btn-sm btn-secondary" onclick="loadIncidents()">
                    <i data-lucide="refresh-cw"></i> Refresh
                  </button>
                </div>
                <div id="helpdesk-incidents-table" class="incidents-table-container">
                  <p class="text-muted">Loading incidents...</p>
                </div>
              </div>

              <!-- Email Queue -->
              <div class="helpdesk-section">
                <div class="helpdesk-section-header">
                  <h3>Email Queue</h3>
                  <span id="helpdesk-queue-count" class="badge" style="display:none;">0 pending</span>
                  <button type="button" class="btn btn-sm btn-primary" onclick="processEmailQueueNow()">
                    <i data-lucide="play"></i> Process Queue Now
                  </button>
                </div>
                <div id="helpdesk-queue-table" class="incidents-table-container">
                  <p class="text-muted">Loading queue...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Computer Repair Tab -->
          <div id="tab-computer-repair" class="tab-content">
            <div class="helpdesk-container cr-container">
              <div class="helpdesk-header">
                <h2><i data-lucide="laptop"></i> Computer Repair</h2>
              </div>

              <!-- Site Number Config -->
              <div class="helpdesk-config">
                <label for="cr-site-number">Site Number</label>
                <input type="text" id="cr-site-number" placeholder="e.g. 1681" style="width:80px;" />
                <button type="button" class="btn btn-sm" onclick="saveCrSiteNumber()">Save</button>
                <span id="cr-site-status" style="margin-left:8px; font-size:12px; color:#888;"></span>
              </div>

              <!-- Ticket Mode Toggle -->
              <div class="cr-ticket-mode-toggle">
                <button type="button" class="cr-ticket-mode-btn active" id="cr-mode-full-btn" onclick="setCrTicketMode('full')">
                  <i data-lucide="laptop"></i>
                  <span>Full Form</span>
                  <small>Serial number &amp; device info</small>
                </button>
                <button type="button" class="cr-ticket-mode-btn" id="cr-mode-quick-btn" onclick="setCrTicketMode('quick')">
                  <i data-lucide="zap"></i>
                  <span>Quick Ticket</span>
                  <small>Daily issues, no device details</small>
                </button>
                <div class="cr-template-dropdown-wrapper" id="cr-template-dropdown">
                  <button type="button" class="cr-ticket-mode-btn" id="cr-mode-template-btn" onclick="toggleTemplateDropdown()">
                    <i data-lucide="layout-template"></i>
                    <span id="cr-template-btn-label">Templates</span>
                    <small>Pre-filled recurring issues <i data-lucide="chevron-down" style="width:12px;height:12px;display:inline;vertical-align:middle;"></i></small>
                  </button>
                  <div class="cr-template-dropdown-menu" id="cr-template-dropdown-menu">
                    <!-- Populated dynamically by renderTemplateDropdown() -->
                    <div class="cr-template-empty">Loading templates...</div>
                  </div>
                </div>
              </div>

              <!-- Template / MAX Case Form (hidden by default) -->
              <div id="cr-maxcase-form" class="helpdesk-form" style="display:none;">
                <div class="cr-template-form-header" id="mc-form-header">
                  <h3 id="mc-form-heading">Template Ticket</h3>
                  <button type="button" class="btn btn-ghost btn-sm" onclick="templateResetForm(); setCrTicketMode('full');">
                    <i data-lucide="arrow-left"></i> Back
                  </button>
                </div>
                <!-- Step 1: Employee Lookup -->
                <div class="helpdesk-step">
                  <div class="step-header">
                    <span class="step-number">1</span>
                    <h3>Employee Lookup</h3>
                  </div>
                  <div class="step-content">
                    <div class="helpdesk-input-row">
                      <label for="mc-emp-id">Employee ID</label>
                      <div class="helpdesk-input-group">
                        <input type="text" id="mc-emp-id" placeholder="Enter employee ID..." />
                        <button type="button" class="btn btn-primary btn-sm" onclick="maxCaseLookupEmployee()">
                          <i data-lucide="search"></i> Look Up
                        </button>
                      </div>
                    </div>
                    <div id="mc-employee-result" class="employee-lookup-result hidden">
                      <div class="employee-found">
                        <i data-lucide="check-circle" class="employee-check-icon"></i>
                        <div class="employee-info">
                          <span id="mc-emp-name" class="emp-name"></span>
                          <span id="mc-emp-details" class="emp-details"></span>
                        </div>
                      </div>
                    </div>
                    <div id="mc-employee-error" class="employee-lookup-error hidden">
                      <i data-lucide="alert-circle"></i>
                      <span>Employee not found. Check the ID and try again.</span>
                    </div>
                  </div>
                </div>

                <!-- Step 2: Scan/Enter Serial, Warranty, Asset Tag -->
                <div class="helpdesk-step" id="mc-step-device">
                  <div class="step-header">
                    <span class="step-number cr-step-accent">2</span>
                    <h3>Device Info (Scan or Enter)</h3>
                  </div>
                  <div class="step-content">
                    <div class="cr-serial-mode-toggle">
                      <button type="button" class="btn btn-sm btn-secondary cr-mode-btn active" id="mc-mode-manual-btn" onclick="maxCaseSetSerialMode('manual')">
                        <i data-lucide="keyboard"></i> Manual Entry
                      </button>
                      <button type="button" class="btn btn-sm btn-secondary cr-mode-btn" id="mc-mode-scan-btn" onclick="maxCaseSetSerialMode('scan')">
                        <i data-lucide="camera"></i> Scan with Webcam
                      </button>
                    </div>

                    <!-- Manual entry -->
                    <div id="mc-manual-entry" class="cr-serial-section">
                      <div class="helpdesk-two-col" style="margin-top:12px;">
                        <div class="helpdesk-input-row">
                          <label for="mc-serial-number">Service Tag / Serial Number <span class="required-star">*</span></label>
                          <input type="text" id="mc-serial-number" placeholder="e.g. 8TN7N94" />
                        </div>
                        <div class="helpdesk-input-row">
                          <label for="mc-asset-tag">Asset Tag</label>
                          <input type="text" id="mc-asset-tag" placeholder="e.g. 8TN7N94" />
                        </div>
                      </div>
                      <div class="helpdesk-input-row">
                        <label for="mc-warranty-date">Warranty Expiration Date</label>
                        <input type="date" id="mc-warranty-date" />
                      </div>
                    </div>

                    <!-- Webcam scanner -->
                    <div id="mc-webcam-entry" class="cr-serial-section" style="display:none;">
                      <div class="cr-webcam-container">
                        <video id="mc-webcam-video" autoplay playsinline class="cr-webcam-video"></video>
                        <canvas id="mc-webcam-canvas" style="display:none;"></canvas>
                        <div class="cr-webcam-controls">
                          <button type="button" class="btn btn-primary btn-sm" onclick="maxCaseStartWebcam()">
                            <i data-lucide="video"></i> Start Camera
                          </button>
                          <button type="button" class="btn btn-secondary btn-sm" onclick="maxCaseCapturePhoto()">
                            <i data-lucide="camera"></i> Capture &amp; OCR
                          </button>
                          <button type="button" class="btn btn-sm" onclick="maxCaseStopWebcam()">
                            <i data-lucide="video-off"></i> Stop
                          </button>
                        </div>
                        <div id="mc-ocr-status" class="cr-ocr-status" style="display:none;">
                          <div class="spinner" style="width:18px;height:18px;border-width:2px;"></div>
                          <span id="mc-ocr-status-text">Processing image...</span>
                        </div>
                        <div id="mc-captured-preview" class="cr-captured-preview" style="display:none;">
                          <img id="mc-captured-image" alt="Captured sticker" />
                        </div>
                        <div id="mc-ocr-result" class="cr-ocr-result" style="display:none;">
                          <h4>OCR Results</h4>
                          <div class="cr-ocr-fields">
                            <div class="helpdesk-input-row">
                              <label>Detected Serial:</label>
                              <div class="helpdesk-input-group">
                                <input type="text" id="mc-ocr-serial" placeholder="Detected serial..." readonly />
                                <button type="button" class="btn btn-primary btn-sm" onclick="maxCaseAcceptOcrSerial()">
                                  <i data-lucide="check"></i> Use
                                </button>
                              </div>
                            </div>
                            <div class="helpdesk-input-row">
                              <label>Detected Warranty Date:</label>
                              <div class="helpdesk-input-group">
                                <input type="text" id="mc-ocr-warranty" placeholder="Detected date..." readonly />
                                <button type="button" class="btn btn-primary btn-sm" onclick="maxCaseAcceptOcrWarranty()">
                                  <i data-lucide="check"></i> Use
                                </button>
                              </div>
                            </div>
                            <div class="helpdesk-input-row">
                              <label>Raw OCR Text:</label>
                              <textarea id="mc-ocr-raw" rows="3" readonly style="font-size:12px;color:var(--text-muted);"></textarea>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Photo for ServiceNow -->
                    <div id="mc-step-photo" style="margin-top:12px;">
                      <label style="font-weight:600;" id="mc-photo-label">Photo of Device</label>
                      <p style="font-size:12px; color:var(--text-muted); margin:4px 0 8px;">Auto-copied to clipboard when you open ServiceNow. Just press Ctrl+V / Cmd+V to attach it.</p>
                      <div class="cr-webcam-container" style="margin-top:6px;">
                        <video id="mc-photo-video" autoplay playsinline class="cr-webcam-video" style="max-height:200px;"></video>
                        <canvas id="mc-photo-canvas" style="display:none;"></canvas>
                        <div class="cr-webcam-controls">
                          <button type="button" class="btn btn-primary btn-sm" onclick="maxCaseStartPhotoCamera()">
                            <i data-lucide="camera"></i> Take Photo
                          </button>
                          <button type="button" class="btn btn-secondary btn-sm" onclick="maxCaseCapturePhotoEvidence()">
                            <i data-lucide="image"></i> Capture
                          </button>
                          <button type="button" class="btn btn-sm" onclick="maxCaseStopPhotoCamera()">
                            <i data-lucide="video-off"></i> Stop
                          </button>
                        </div>
                        <div id="mc-photo-preview" class="cr-captured-preview" style="display:none;">
                          <img id="mc-photo-image" alt="Captured evidence photo" style="max-height:200px;" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Pre-filled Summary (read-only, shown for reference) -->
                <div class="helpdesk-step">
                  <div class="step-header">
                    <span class="step-number" style="background:#f59e0b;">3</span>
                    <h3>Pre-filled Ticket Details</h3>
                    <span class="badge" style="background:#fef3c7;color:#92400e;margin-left:8px;">Auto-filled</span>
                  </div>
                  <div class="step-content">
                    <div id="mc-prefilled-summary" style="background:var(--bg-secondary);border-radius:8px;padding:12px;font-size:13px;line-height:1.6;">
                      <em>Select a template to see pre-filled values</em>
                    </div>
                  </div>
                </div>

                <!-- Step 4: Open ServiceNow -->
                <div class="helpdesk-step">
                  <div class="step-header">
                    <span class="step-number">4</span>
                    <h3>ServiceNow</h3>
                  </div>
                  <div class="step-content">
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                      <button type="button" class="btn btn-secondary" onclick="templateOpenServiceNow()" id="mc-open-sn-btn">
                        <i data-lucide="external-link"></i> Open ServiceNow (Pre-filled)
                      </button>
                    </div>
                    <div class="helpdesk-input-row" style="margin-top:12px;">
                      <label for="mc-inc-number">Incident Number <span style="color:#64748b;font-size:11px;">(optional)</span></label>
                      <div class="helpdesk-input-group">
                        <input type="text" id="mc-inc-number" placeholder="Paste INC number after submitting" style="font-family: monospace; font-size: 15px; letter-spacing: 1px;" />
                        <button type="button" class="btn btn-secondary btn-sm" onclick="maxCasePasteInc()" title="Paste from clipboard">
                          <i data-lucide="clipboard-paste"></i> Paste
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Step 5: Save & Notify -->
                <div class="helpdesk-step">
                  <div class="step-header">
                    <span class="step-number">5</span>
                    <h3>Save &amp; Notify</h3>
                  </div>
                  <div class="step-content">
                    <div class="incident-actions">
                      <button type="button" class="btn btn-primary" onclick="templateSaveAndSend()">
                        <i data-lucide="send"></i> Save &amp; Send Email Now
                      </button>
                      <button type="button" class="btn btn-secondary" onclick="templateSaveAndQueue()">
                        <i data-lucide="clock"></i> Save &amp; Queue Email for Later
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="helpdesk-form" id="cr-main-form">
                <!-- Step 1: Employee Lookup -->
                <div class="helpdesk-step">
                  <div class="step-header">
                    <span class="step-number">1</span>
                    <h3>Employee Lookup</h3>
                  </div>
                  <div class="step-content">
                    <div class="helpdesk-input-row">
                      <label for="cr-emp-id">Employee ID</label>
                      <div class="helpdesk-input-group">
                        <input type="text" id="cr-emp-id" placeholder="Enter employee ID..." />
                        <button type="button" class="btn btn-primary btn-sm" onclick="computerRepairLookupEmployee()">
                          <i data-lucide="search"></i> Look Up
                        </button>
                      </div>
                    </div>
                    <div id="cr-employee-result" class="employee-lookup-result hidden">
                      <div class="employee-found">
                        <i data-lucide="check-circle" class="employee-check-icon"></i>
                        <div class="employee-info">
                          <span id="cr-emp-name" class="emp-name"></span>
                          <span id="cr-emp-details" class="emp-details"></span>
                        </div>
                      </div>
                    </div>
                    <div id="cr-employee-error" class="employee-lookup-error hidden">
                      <i data-lucide="alert-circle"></i>
                      <span>Employee not found. Check the ID and try again.</span>
                    </div>
                  </div>
                </div>

                <!-- Step 2: Serial Number & Device Info (hidden in Quick Ticket mode) -->
                <div class="helpdesk-step" id="cr-step-device-info">
                  <div class="step-header">
                    <span class="step-number cr-step-accent">2</span>
                    <h3>Serial Number &amp; Device Info</h3>
                  </div>
                  <div class="step-content">
                    <div class="cr-serial-mode-toggle">
                      <button type="button" class="btn btn-sm btn-secondary cr-mode-btn active" id="cr-mode-manual-btn" onclick="computerRepairSetSerialMode('manual')">
                        <i data-lucide="keyboard"></i> Manual Entry
                      </button>
                      <button type="button" class="btn btn-sm btn-secondary cr-mode-btn" id="cr-mode-scan-btn" onclick="computerRepairSetSerialMode('scan')">
                        <i data-lucide="camera"></i> Scan with Webcam
                      </button>
                    </div>

                    <!-- Manual entry -->
                    <div id="cr-manual-entry" class="cr-serial-section">
                      <div class="helpdesk-input-row">
                        <label for="cr-serial-number">Serial Number <span class="required-star">*</span></label>
                        <input type="text" id="cr-serial-number" placeholder="Enter serial number..." />
                      </div>
                    </div>

                    <!-- Webcam scanner -->
                    <div id="cr-webcam-entry" class="cr-serial-section" style="display:none;">
                      <div class="cr-webcam-container">
                        <video id="cr-webcam-video" autoplay playsinline class="cr-webcam-video"></video>
                        <canvas id="cr-webcam-canvas" style="display:none;"></canvas>
                        <div class="cr-webcam-controls">
                          <button type="button" class="btn btn-primary btn-sm" onclick="computerRepairStartWebcam()">
                            <i data-lucide="video"></i> Start Camera
                          </button>
                          <button type="button" class="btn btn-secondary btn-sm" onclick="computerRepairCapturePhoto()">
                            <i data-lucide="camera"></i> Capture &amp; OCR
                          </button>
                          <button type="button" class="btn btn-sm" onclick="computerRepairStopWebcam()">
                            <i data-lucide="video-off"></i> Stop
                          </button>
                        </div>
                        <div id="cr-ocr-status" class="cr-ocr-status" style="display:none;">
                          <div class="spinner" style="width:18px;height:18px;border-width:2px;"></div>
                          <span id="cr-ocr-status-text">Processing image...</span>
                        </div>
                        <div id="cr-captured-preview" class="cr-captured-preview" style="display:none;">
                          <img id="cr-captured-image" alt="Captured sticker" />
                        </div>
                        <div id="cr-ocr-result" class="cr-ocr-result" style="display:none;">
                          <h4>OCR Results</h4>
                          <div class="cr-ocr-fields">
                            <div class="helpdesk-input-row">
                              <label>Detected Serial:</label>
                              <div class="helpdesk-input-group">
                                <input type="text" id="cr-ocr-serial" placeholder="Detected serial..." readonly />
                                <button type="button" class="btn btn-primary btn-sm" onclick="computerRepairAcceptOcrSerial()">
                                  <i data-lucide="check"></i> Use
                                </button>
                              </div>
                            </div>
                            <div class="helpdesk-input-row">
                              <label>Detected Warranty Date:</label>
                              <div class="helpdesk-input-group">
                                <input type="text" id="cr-ocr-warranty" placeholder="Detected date..." readonly />
                                <button type="button" class="btn btn-primary btn-sm" onclick="computerRepairAcceptOcrWarranty()">
                                  <i data-lucide="check"></i> Use
                                </button>
                              </div>
                            </div>
                            <div class="helpdesk-input-row">
                              <label>Raw OCR Text:</label>
                              <textarea id="cr-ocr-raw" rows="3" readonly style="font-size:12px;color:var(--text-muted);"></textarea>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Device info fields -->
                    <div class="helpdesk-two-col" style="margin-top:12px;">
                      <div class="helpdesk-input-row">
                        <label for="cr-model">Computer Model</label>
                        <input type="text" id="cr-model" placeholder="e.g. Chromebook 3120 2-in-1" />
                      </div>
                      <div class="helpdesk-input-row">
                        <label for="cr-manufacturer">Manufacturer</label>
                        <select id="cr-manufacturer">
                          <option value="">-- Select --</option>
                          <option value="Dell">Dell</option>
                          <option value="HP">HP</option>
                          <option value="Lenovo">Lenovo</option>
                          <option value="Apple">Apple</option>
                          <option value="Acer">Acer</option>
                          <option value="ASUS">ASUS</option>
                          <option value="Samsung">Samsung</option>
                          <option value="Other">Other</option>
                        </select>
                      </div>
                    </div>
                    <div class="helpdesk-two-col">
                      <div class="helpdesk-input-row">
                        <label for="cr-warranty-date">Warranty Expiration</label>
                        <input type="date" id="cr-warranty-date" />
                      </div>
                      <div class="helpdesk-input-row">
                        <label for="cr-asset-tag">Asset Tag</label>
                        <input type="text" id="cr-asset-tag" placeholder="Optional asset tag..." />
                      </div>
                    </div>
                    <div id="cr-warranty-status-display" style="display:none; margin-top:8px;">
                      <span id="cr-warranty-badge" class="inc-status"></span>
                    </div>
                  </div>
                </div>

                <!-- AI Issue Description (learns from past tickets) -->
                <div class="helpdesk-step" id="cr-step-ai">
                  <div class="step-header">
                    <span class="step-number cr-step-ai" id="cr-ai-step-num">2</span>
                    <h3>Describe the Issue</h3>
                    <span class="badge badge-ai" style="margin-left:8px;">AI Assist</span>
                  </div>
                  <div class="step-content">
                    <div class="helpdesk-input-row">
                      <label for="cr-ai-input">What's the problem? <small style="color:var(--text-muted);">(AI will suggest category & details)</small></label>
                      <textarea id="cr-ai-input" rows="3" placeholder="e.g. Single point scanner not working, Teacher's laptop won't turn on, Projector showing no signal..."></textarea>
                      <div id="cr-ai-spinner" class="ai-spinner" style="display:none;">
                        <div class="spinner"></div>
                        <span>Analyzing...</span>
                      </div>
                    </div>
                    <!-- AI Suggestion Panel -->
                    <div id="cr-ai-suggestion-panel" class="ai-suggestion-panel" style="display:none;">
                      <div class="ai-suggestion-header">
                        <span class="ai-suggestion-title"><i data-lucide="sparkles"></i> AI Suggestions</span>
                        <span id="cr-ai-confidence-badge" class="ai-confidence-badge">0%</span>
                        <span id="cr-ai-source-badge" class="ai-source-badge">rules</span>
                      </div>
                      <div class="ai-suggestion-grid">
                        <div class="ai-suggestion-item">
                          <label>Category</label>
                          <span id="cr-ai-suggest-category">‚Äî</span>
                          <button type="button" class="ai-accept-btn" onclick="crAcceptAiField('category')">Accept</button>
                        </div>
                        <div class="ai-suggestion-item">
                          <label>Subcategory</label>
                          <span id="cr-ai-suggest-subcategory">‚Äî</span>
                          <button type="button" class="ai-accept-btn" onclick="crAcceptAiField('subcategory')">Accept</button>
                        </div>
                        <div class="ai-suggestion-item">
                          <label>Priority</label>
                          <span id="cr-ai-suggest-priority" class="ai-priority-badge">‚Äî</span>
                          <button type="button" class="ai-accept-btn" onclick="crAcceptAiField('priority')">Accept</button>
                        </div>
                        <div class="ai-suggestion-item">
                          <label>Est. Time</label>
                          <span id="cr-ai-suggest-time">‚Äî</span>
                        </div>
                        <div class="ai-suggestion-item">
                          <label>Channel</label>
                          <span id="cr-ai-suggest-channel">‚Äî</span>
                          <button type="button" class="ai-accept-btn" onclick="crAcceptAiField('channel')">Accept</button>
                        </div>
                        <div class="ai-suggestion-item">
                          <label>Impact</label>
                          <span id="cr-ai-suggest-impact">‚Äî</span>
                          <button type="button" class="ai-accept-btn" onclick="crAcceptAiField('impact')">Accept</button>
                        </div>
                        <div class="ai-suggestion-item full-width">
                          <label><i data-lucide="file-text" style="width:14px;height:14px;"></i> Professional Description</label>
                          <span id="cr-ai-suggest-description" class="ai-description-text">‚Äî</span>
                          <button type="button" class="ai-accept-btn" onclick="crAcceptAiField('description')">Accept</button>
                        </div>
                        <div class="ai-suggestion-item full-width" id="cr-ai-troubleshooting-row" style="display:none;">
                          <label><i data-lucide="wrench" style="width:14px;height:14px;"></i> Troubleshooting Steps</label>
                          <span id="cr-ai-suggest-troubleshooting" class="ai-troubleshooting-text">‚Äî</span>
                          <button type="button" class="ai-accept-btn" onclick="crAcceptAiField('troubleshooting')">Copy</button>
                        </div>
                      </div>
                      <div class="ai-suggestion-actions">
                        <button type="button" class="btn btn-primary btn-sm ai-accept-all-btn" onclick="crAcceptAllAiSuggestions()">
                          <i data-lucide="check-check"></i> Accept All Suggestions
                        </button>
                      </div>
                    </div>
                    <!-- Recent Similar Issues -->
                    <div id="cr-similar-issues" class="cr-similar-issues" style="display:none;">
                      <div class="cr-similar-header">
                        <i data-lucide="history"></i> Similar Past Issues
                      </div>
                      <div id="cr-similar-list" class="cr-similar-list"></div>
                    </div>
                  </div>
                </div>

                <!-- Step 3: Issue Details -->
                <div class="helpdesk-step">
                  <div class="step-header">
                    <span class="step-number" id="cr-details-step-num">3</span>
                    <h3>Issue Details</h3>
                  </div>
                  <div class="step-content">
                    <div class="helpdesk-input-row">
                      <label for="cr-channel">Channel</label>
                      <select id="cr-channel">
                        <option value="">-- None --</option>
                        <option value="walk-in">Walk-in</option>
                        <option value="phone">Phone</option>
                        <option value="email">Email</option>
                        <option value="self-service" selected>Self-service</option>
                        <option value="chat">Chat</option>
                      </select>
                    </div>
                    <div class="helpdesk-two-col">
                      <div class="helpdesk-input-row">
                        <label for="cr-category">Category <span class="required-star">*</span></label>
                        <select id="cr-category" onchange="onComputerRepairCategoryChange()">
                          <option value="">-- None --</option>
                          <option value="Hardware">Hardware</option>
                          <option value="Software">Software</option>
                          <option value="Network">Network</option>
                        </select>
                      </div>
                      <div class="helpdesk-input-row">
                        <label for="cr-subcategory">Subcategory</label>
                        <select id="cr-subcategory">
                          <option value="">-- Select Category first --</option>
                        </select>
                      </div>
                    </div>
                    <div class="helpdesk-two-col">
                      <div class="helpdesk-input-row">
                        <label for="cr-impact">Impact</label>
                        <select id="cr-impact">
                          <option value="4" selected>Individual</option>
                          <option value="3">Single School/Department</option>
                          <option value="2">Multiple Schools/Departments</option>
                          <option value="1">District</option>
                        </select>
                      </div>
                      <div class="helpdesk-input-row">
                        <label for="cr-user-type">User Type</label>
                        <select id="cr-user-type">
                          <option value="">-- None --</option>
                          <option value="school_staff" selected>School Staff</option>
                          <option value="department_staff">Department Staff</option>
                          <option value="student">Student</option>
                          <option value="non-district person">Non-District Person</option>
                        </select>
                      </div>
                    </div>
                    <div class="helpdesk-input-row">
                      <label for="cr-short-desc">Short Description <span class="required-star">*</span></label>
                      <input type="text" id="cr-short-desc" placeholder="Brief summary of the issue..." maxlength="160" />
                    </div>
                    <div class="helpdesk-input-row">
                      <label for="cr-full-desc">Description</label>
                      <textarea id="cr-full-desc" rows="4" placeholder="Please provide additional details about the computer issue..."></textarea>
                    </div>
                  </div>
                </div>

                <!-- Step 4: ServiceNow -->
                <div class="helpdesk-step">
                  <div class="step-header">
                    <span class="step-number" id="cr-sn-step-num">4</span>
                    <h3>ServiceNow</h3>
                  </div>
                  <div class="step-content">
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                      <button type="button" class="btn btn-secondary" onclick="computerRepairOpenServiceNow()" id="cr-open-sn-btn">
                        <i data-lucide="external-link"></i> Open ServiceNow (Pre-filled)
                      </button>
                    </div>
                    <div class="helpdesk-input-row" style="margin-top:12px;">
                      <label for="cr-inc-number">Incident Number <span style="color:#64748b;font-size:11px;">(optional)</span></label>
                      <div class="helpdesk-input-group">
                        <input type="text" id="cr-inc-number" placeholder="Auto-fills when you submit in ServiceNow" style="font-family: monospace; font-size: 15px; letter-spacing: 1px;" />
                        <button type="button" class="btn btn-secondary btn-sm" id="cr-paste-btn" onclick="crPasteIncFromClipboard()" title="Paste from clipboard" style="display:none;">
                          <i data-lucide="clipboard-paste"></i> Paste
                        </button>
                      </div>
                      <span id="cr-inc-status" style="font-size:12px; color:#22c55e; margin-top:4px; display:block;">
                        <i data-lucide="zap" style="width:14px;height:14px;display:inline-block;vertical-align:middle;margin-right:4px;"></i>
                        <span id="cr-inc-status-text">INC will auto-fill after you submit in ServiceNow (Chrome extension)</span>
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Step 5: Save & Notify -->
                <div class="helpdesk-step">
                  <div class="step-header">
                    <span class="step-number" id="cr-save-step-num">5</span>
                    <h3>Save &amp; Notify</h3>
                  </div>
                  <div class="step-content">
                    <div class="incident-actions">
                      <button type="button" class="btn btn-primary" onclick="computerRepairSaveAndSend()">
                        <i data-lucide="send"></i> Save &amp; Send Email Now
                      </button>
                      <button type="button" class="btn btn-secondary" onclick="computerRepairSaveAndQueue()">
                        <i data-lucide="clock"></i> Save &amp; Queue Email for Later
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Recent Computer Repairs Table - Inside the form area -->
                <div class="helpdesk-step" style="border-left: 3px solid #3b82f6; margin-top: 24px;">
                  <div class="step-header" style="cursor: pointer;" onclick="toggleCrRepairsList()">
                    <span class="step-number" style="background: #3b82f6;"><i data-lucide="list" style="width:16px;height:16px;"></i></span>
                    <h3>Recent Computer Repairs</h3>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); loadComputerRepairs();" style="margin-left: auto;">
                      <i data-lucide="refresh-cw"></i> Refresh
                    </button>
                    <i data-lucide="chevron-down" id="cr-repairs-toggle-icon" style="width:20px;height:20px;margin-left:8px;transition:transform 0.2s;"></i>
                  </div>
                  <div class="step-content" id="cr-repairs-list-container" style="max-height: 400px; overflow-y: auto;">
                    <div id="cr-repairs-table" class="incidents-table-container">
                      <p class="text-muted">Loading repairs...</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Analytics Tab -->
          <div id="tab-analytics" class="tab-content">
            <div class="analytics-container">
              <div class="analytics-header">
                <h2><i data-lucide="bar-chart-3"></i> Help Desk Analytics</h2>
                <button type="button" class="btn btn-secondary btn-sm" onclick="loadAnalytics()">
                  <i data-lucide="refresh-cw"></i> Refresh
                </button>
              </div>

              <!-- Summary Cards -->
              <div class="analytics-summary" id="analytics-summary">
                <div class="stat-card">
                  <div class="stat-icon" style="background:#ede9fe;color:#7c3aed;"><i data-lucide="ticket"></i></div>
                  <div class="stat-info">
                    <span class="stat-value" id="stat-total">‚Äî</span>
                    <span class="stat-label">Total Incidents</span>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon" style="background:#fef3c7;color:#d97706;"><i data-lucide="alert-circle"></i></div>
                  <div class="stat-info">
                    <span class="stat-value" id="stat-open">‚Äî</span>
                    <span class="stat-label">Open Incidents</span>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon" style="background:#d1fae5;color:#059669;"><i data-lucide="check-circle-2"></i></div>
                  <div class="stat-info">
                    <span class="stat-value" id="stat-closed">‚Äî</span>
                    <span class="stat-label">Closed</span>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon" style="background:#e0e7ff;color:#4f46e5;"><i data-lucide="cpu"></i></div>
                  <div class="stat-info">
                    <span class="stat-value" id="stat-ai-accuracy">‚Äî</span>
                    <span class="stat-label">AI Accuracy</span>
                  </div>
                </div>
              </div>

              <!-- Charts Row 1 -->
              <div class="analytics-grid">
                <div class="chart-panel">
                  <h3><i data-lucide="users"></i> Top 10 Requesters</h3>
                  <div id="chart-top-requesters" class="chart-body">
                    <p class="text-muted">Loading...</p>
                  </div>
                </div>
                <div class="chart-panel">
                  <h3><i data-lucide="pie-chart"></i> Category Distribution</h3>
                  <div id="chart-categories" class="chart-body">
                    <p class="text-muted">Loading...</p>
                  </div>
                </div>
              </div>

              <!-- Charts Row 2 -->
              <div class="analytics-grid">
                <div class="chart-panel">
                  <h3><i data-lucide="trending-up"></i> Incidents Over Time</h3>
                  <div id="chart-monthly" class="chart-body">
                    <p class="text-muted">Loading...</p>
                  </div>
                </div>
                <div class="chart-panel">
                  <h3><i data-lucide="radio"></i> Channel Distribution</h3>
                  <div id="chart-channels" class="chart-body">
                    <p class="text-muted">Loading...</p>
                  </div>
                </div>
              </div>

              <!-- Tables Row -->
              <div class="analytics-grid">
                <div class="chart-panel">
                  <h3><i data-lucide="list-ordered"></i> Top Issues (Subcategory)</h3>
                  <div id="chart-top-issues" class="chart-body">
                    <p class="text-muted">Loading...</p>
                  </div>
                </div>
                <div class="chart-panel">
                  <h3><i data-lucide="brain"></i> AI Classification Performance</h3>
                  <div id="chart-ai-perf" class="chart-body">
                    <p class="text-muted">Loading...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Settings Tab -->
          <div id="tab-settings" class="tab-content">
            <div class="settings-layout">
              <!-- Settings Sidebar -->
              <aside class="settings-sidebar">
                <nav class="settings-nav">
                  <!-- Settings Category -->
                  <div class="settings-nav-category">
                    <div class="settings-nav-header">
                      <i data-lucide="settings"></i>
                      <span>Settings</span>
                    </div>
                    <ul class="settings-nav-items">
                      <li class="settings-nav-item active" data-section="gateway">
                        <i data-lucide="radio-tower"></i>
                        <span>SNMP Gateway Control</span>
                      </li>
                      <li class="settings-nav-item" data-section="security">
                        <i data-lucide="shield"></i>
                        <span>Security Settings</span>
                      </li>
                      <li class="settings-nav-item" data-section="environment">
                        <i data-lucide="flask-conical"></i>
                        <span>Test Environment</span>
                      </li>
                      <li class="settings-nav-item" data-section="theme">
                        <i data-lucide="palette"></i>
                        <span>Theme Customization</span>
                      </li>
                      <li class="settings-nav-item" data-section="splash-screen">
                        <i data-lucide="layout-template"></i>
                        <span>Splash Screen</span>
                      </li>
                      <li class="settings-nav-item has-submenu" data-section="icons">
                        <i data-lucide="shapes"></i>
                        <span>Icons Customization</span>
                        <i data-lucide="chevron-right" class="submenu-arrow"></i>
                      </li>
                    </ul>
                  </div>

                  <!-- Staff Category -->
                  <div class="settings-nav-category">
                    <div class="settings-nav-header">
                      <i data-lucide="users"></i>
                      <span>Staff</span>
                    </div>
                    <ul class="settings-nav-items">
                      <li class="settings-nav-item" data-section="teachers">
                        <i data-lucide="graduation-cap"></i>
                        <span>Teachers</span>
                      </li>
                      <li class="settings-nav-item" data-section="technicians">
                        <i data-lucide="wrench"></i>
                        <span>Technicians</span>
                      </li>
                    </ul>
                  </div>

                  <!-- Device Management Category -->
                  <div class="settings-nav-category">
                    <div class="settings-nav-header">
                      <i data-lucide="monitor"></i>
                      <span>Device Management</span>
                    </div>
                    <ul class="settings-nav-items">
                      <li class="settings-nav-item" data-section="device-types">
                        <i data-lucide="layers"></i>
                        <span>Device Types</span>
                      </li>
                      <li class="settings-nav-item" data-section="issue-buttons">
                        <i data-lucide="mouse-pointer-click"></i>
                        <span>Issue Buttons</span>
                      </li>
                      <li class="settings-nav-item" data-section="repair-templates">
                        <i data-lucide="layout-template"></i>
                        <span>Repair Templates</span>
                      </li>
                    </ul>
                  </div>

                  <!-- QR Code Labels -->
                  <div class="settings-nav-category">
                    <div class="settings-nav-header clickable" data-section="qr-codes">
                      <i data-lucide="qr-code"></i>
                      <span>QR Code Labels</span>
                    </div>
                  </div>

                  <!-- Communications Category -->
                  <div class="settings-nav-category">
                    <div class="settings-nav-header">
                      <i data-lucide="mail"></i>
                      <span>Communications</span>
                    </div>
                    <ul class="settings-nav-items">
                      <li class="settings-nav-item" data-section="email-templates">
                        <i data-lucide="file-text"></i>
                        <span>Email Templates</span>
                      </li>
                    </ul>
                  </div>

                  <!-- Application Category -->
                  <div class="settings-nav-category">
                    <div class="settings-nav-header">
                      <i data-lucide="app-window"></i>
                      <span>Application</span>
                    </div>
                    <ul class="settings-nav-items">
                      <li class="settings-nav-item" data-section="app-settings">
                        <i data-lucide="sliders-horizontal"></i>
                        <span>Settings</span>
                      </li>
                      <li class="settings-nav-item" data-section="data-management">
                        <i data-lucide="database"></i>
                        <span>Data Management</span>
                      </li>
                      <li class="settings-nav-item" data-section="ai-intelligence">
                        <i data-lucide="brain"></i>
                        <span>AI Intelligence</span>
                      </li>
                      <li class="settings-nav-item" data-section="danger-zone">
                        <i data-lucide="alert-triangle"></i>
                        <span>Danger Zone</span>
                      </li>
                      <li class="settings-nav-item" data-section="debug-console">
                        <i data-lucide="bug"></i>
                        <span>Debug Console</span>
                      </li>
                    </ul>
                  </div>
                </nav>
              </aside>

              <!-- Settings Content -->
              <div class="settings-content">
                <!-- SNMP Gateway Control Section -->
                <div class="settings-panel active" id="settings-panel-gateway">
                  <div class="settings-section gateway-section">
                    <div class="section-title-row">
                      <h2 class="section-title"><i data-lucide="radio-tower"></i> SNMP Gateway Control</h2>
                <div id="launcher-status" class="launcher-status-badge">
                  <span class="launcher-offline"><i data-lucide="terminal"></i> Manual mode</span>
                </div>
              </div>
              <p class="section-desc">Control the SNMP gateway that captures traps from your printers/copiers</p>

              <div class="gateway-control-panel">
                <div class="gateway-status-card">
                  <div class="gateway-status-icon" id="gateway-status-icon">
                    <i data-lucide="wifi-off"></i>
                  </div>
                  <div class="gateway-status-info">
                    <h4 id="gateway-status-title">Gateway Offline</h4>
                    <p id="gateway-status-desc">Not receiving SNMP data</p>
                  </div>
                </div>

                <div class="gateway-actions">
                  <button type="button" class="btn btn-success btn-lg" id="btn-start-gateway" onclick="startGateway()">
                    <i data-lucide="play"></i> Start Gateway
                  </button>
                  <button type="button" class="btn btn-danger btn-lg hidden" id="btn-stop-gateway" onclick="stopGateway()">
                    <i data-lucide="square"></i> Stop Gateway
                  </button>
                  <button type="button" class="btn btn-outline" onclick="checkGatewayStatus(true)">
                    <i data-lucide="refresh-cw"></i> Check Status
                  </button>
                  <button type="button" class="btn btn-outline" onclick="restartGateway()" id="btn-restart-gateway">
                    <i data-lucide="rotate-cw"></i> Restart
                  </button>
                  <button type="button" class="btn btn-outline" onclick="fetchGatewayLogs()">
                    <i data-lucide="scroll-text"></i> View Logs
                  </button>
                </div>

                <div class="gateway-info-box">
                  <h4><i data-lucide="info"></i> How it works</h4>
                  <ol>
                    <li>Set the <strong>Trap Port</strong> below (162 is standard, matches your copier setting)</li>
                    <li>Click <strong>Start Gateway</strong> and run the command in Terminal</li>
                    <li>Configure your copiers to send traps to: <code id="gateway-ip">your-mac-ip</code>:<code id="gateway-port-display">162</code></li>
                  </ol>
                </div>

                <div class="gateway-config">
                  <h4>Gateway Configuration</h4>
                  <div class="form-row">
                    <div class="form-group">
                      <label>SNMP Trap Port</label>
                      <input type="number" id="setting-trap-port" value="162" min="1" max="65535">
                      <small style="color: var(--text-muted); font-size: 12px;">Standard SNMP port is 162. May require admin privileges on some systems.</small>
                    </div>
                    <div class="form-group">
                      <label>Trap Listener Mode</label>
                      <div class="trap-listener-toggle">
                        <div class="listener-status" id="trap-listener-status">
                          <span class="status-dot offline"></span>
                          <span id="trap-listener-text">Listener Off</span>
                        </div>
                        <div class="listener-controls">
                          <button type="button" class="btn btn-success btn-sm" id="btn-start-listener" onclick="startTrapListener()">
                            <i data-lucide="radio"></i> Start Listening
                          </button>
                          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-stop-listener" onclick="stopTrapListener()">
                            <i data-lucide="radio-off"></i> Stop Listening
                          </button>
                        </div>
                      </div>
                      <small style="color: var(--text-muted); font-size: 12px;">Captures SNMP trap packets sent by copiers/printers in real-time</small>
                    </div>
                  </div>

                  <div class="trap-stats-row">
                    <div class="trap-stat-card">
                      <div class="trap-stat-icon"><i data-lucide="radio-tower"></i></div>
                      <div class="trap-stat-info">
                        <span class="trap-stat-value" id="traps-received-count">0</span>
                        <span class="trap-stat-label">Traps Received</span>
                      </div>
                    </div>
                    <div class="trap-stat-card">
                      <div class="trap-stat-icon"><i data-lucide="clock"></i></div>
                      <div class="trap-stat-info">
                        <span class="trap-stat-value" id="last-trap-time">Never</span>
                        <span class="trap-stat-label">Last Trap</span>
                      </div>
                    </div>
                    <div class="trap-stat-card">
                      <div class="trap-stat-icon"><i data-lucide="activity"></i></div>
                      <div class="trap-stat-info">
                        <span class="trap-stat-value" id="listener-uptime">-</span>
                        <span class="trap-stat-label">Listener Uptime</span>
                      </div>
                    </div>
                  </div>

                  <div class="trap-options">
                    <h5>Trap Processing Options</h5>
                    <div class="trap-option-row">
                      <label class="toggle-switch">
                        <input type="checkbox" id="trap-auto-resolve" checked>
                        <span class="toggle-slider"></span>
                      </label>
                      <div class="trap-option-info">
                        <span class="trap-option-label">Auto-resolve duplicate traps</span>
                        <small>Automatically mark older traps as resolved when same issue is reported again</small>
                      </div>
                    </div>
                    <div class="trap-option-row">
                      <label class="toggle-switch">
                        <input type="checkbox" id="trap-sound-alert" checked>
                        <span class="toggle-slider"></span>
                      </label>
                      <div class="trap-option-info">
                        <span class="trap-option-label">Sound alert on new traps</span>
                        <small>Play an alert sound when a new SNMP trap is received</small>
                      </div>
                    </div>
                    <div class="trap-option-row">
                      <label class="toggle-switch">
                        <input type="checkbox" id="trap-desktop-notify">
                        <span class="toggle-slider"></span>
                      </label>
                      <div class="trap-option-info">
                        <span class="trap-option-label">Desktop notifications</span>
                        <small>Show browser notification when traps are received</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
                  </div>
                </div>

                <!-- Security Settings Section -->
                <div class="settings-panel" id="settings-panel-security">
                  <div class="settings-section security-section">
                    <h2 class="section-title"><i data-lucide="shield"></i> Security Settings</h2>
                    <p class="section-desc">Protect sensitive areas with a password</p>

                    <div class="security-panel">
                      <div class="security-status-row">
                        <div class="security-info">
                          <h4>Password Protection</h4>
                          <p>Set a password to protect selected tabs</p>
                        </div>
                        <div id="password-status">
                          <span class="status-badge offline"><span class="dot"></span>Disabled</span>
                        </div>
                      </div>
                      <div class="security-actions">
                        <button type="button" class="btn btn-primary" onclick="showChangePasswordModal()">
                          <i data-lucide="key"></i> Set / Change Password
                        </button>
                        <button type="button" class="btn btn-outline" onclick="lockAppNow()" id="lock-app-btn" style="display: none;">
                          <i data-lucide="lock"></i> Lock Now
                        </button>
                        <button type="button" class="btn btn-danger btn-outline" onclick="removePassword()">
                          <i data-lucide="trash-2"></i> Remove Password
                        </button>
                      </div>
                    </div>

                    <!-- Tab Lock Settings -->
                    <div class="security-panel" style="margin-top: 24px;">
                      <h4 style="margin-bottom: 12px;"><i data-lucide="layout-grid"></i> Tab Protection Settings</h4>
                      <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">Choose which tabs require password authentication. Toggle ON to lock, OFF to keep open.</p>

                      <div class="tab-lock-grid" id="tab-lock-grid">
                        <!-- Map View -->
                        <div class="tab-lock-item">
                          <div class="tab-lock-info">
                            <i data-lucide="map"></i>
                            <span>Map View</span>
                          </div>
                          <label class="toggle-switch">
                            <input type="checkbox" id="lock-tab-blueprint" onchange="toggleTabLock('blueprint', this.checked)">
                            <span class="toggle-slider"></span>
                          </label>
                        </div>
                        <!-- Dashboard -->
                        <div class="tab-lock-item">
                          <div class="tab-lock-info">
                            <i data-lucide="layout-dashboard"></i>
                            <span>Dashboard</span>
                          </div>
                          <label class="toggle-switch">
                            <input type="checkbox" id="lock-tab-dashboard" onchange="toggleTabLock('dashboard', this.checked)">
                            <span class="toggle-slider"></span>
                          </label>
                        </div>
                        <!-- Devices -->
                        <div class="tab-lock-item">
                          <div class="tab-lock-info">
                            <i data-lucide="printer"></i>
                            <span>Devices</span>
                          </div>
                          <label class="toggle-switch">
                            <input type="checkbox" id="lock-tab-devices" onchange="toggleTabLock('devices', this.checked)" checked>
                            <span class="toggle-slider"></span>
                          </label>
                        </div>
                        <!-- SNMP Traps -->
                        <div class="tab-lock-item">
                          <div class="tab-lock-info">
                            <i data-lucide="bell"></i>
                            <span>SNMP Traps</span>
                          </div>
                          <label class="toggle-switch">
                            <input type="checkbox" id="lock-tab-traps" onchange="toggleTabLock('traps', this.checked)">
                            <span class="toggle-slider"></span>
                          </label>
                        </div>
                        <!-- Analytics -->
                        <div class="tab-lock-item">
                          <div class="tab-lock-info">
                            <i data-lucide="bar-chart-3"></i>
                            <span>Analytics</span>
                          </div>
                          <label class="toggle-switch">
                            <input type="checkbox" id="lock-tab-analytics" onchange="toggleTabLock('analytics', this.checked)" checked>
                            <span class="toggle-slider"></span>
                          </label>
                        </div>
                        <!-- Service Requests -->
                        <div class="tab-lock-item">
                          <div class="tab-lock-info">
                            <i data-lucide="clipboard-list"></i>
                            <span>Service Requests</span>
                          </div>
                          <label class="toggle-switch">
                            <input type="checkbox" id="lock-tab-requests" onchange="toggleTabLock('requests', this.checked)" checked>
                            <span class="toggle-slider"></span>
                          </label>
                        </div>
                        <!-- Computer Repairs -->
                        <div class="tab-lock-item">
                          <div class="tab-lock-info">
                            <i data-lucide="laptop"></i>
                            <span>Computer Repairs</span>
                          </div>
                          <label class="toggle-switch">
                            <input type="checkbox" id="lock-tab-repairs" onchange="toggleTabLock('repairs', this.checked)" checked>
                            <span class="toggle-slider"></span>
                          </label>
                        </div>
                        <!-- Settings (Always Locked) -->
                        <div class="tab-lock-item">
                          <div class="tab-lock-info">
                            <i data-lucide="settings"></i>
                            <span>Settings</span>
                          </div>
                          <label class="toggle-switch">
                            <input type="checkbox" id="lock-tab-settings" onchange="toggleTabLock('settings', this.checked)" checked>
                            <span class="toggle-slider"></span>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Test Environment Section -->
                <div class="settings-panel" id="settings-panel-environment">
                  <div class="settings-section environment-section">
                    <h2 class="section-title"><i data-lucide="flask-conical"></i> Test Environment</h2>
                    <p class="section-desc">Switch between test mode (for home testing) and production mode (real-time at work)</p>

                    <div class="environment-panel">
                      <!-- Environment Mode Toggle -->
                      <div class="environment-mode-card">
                        <div class="mode-selector">
                          <div class="mode-option" id="mode-production" onclick="setEnvironmentMode('production')">
                            <div class="mode-icon production">
                              <i data-lucide="building-2"></i>
                            </div>
                            <div class="mode-info">
                              <h4>Production Mode</h4>
                              <p>Real-time monitoring at work</p>
                            </div>
                            <div class="mode-check">
                              <i data-lucide="check-circle-2"></i>
                            </div>
                          </div>
                          <div class="mode-option" id="mode-test" onclick="setEnvironmentMode('test')">
                            <div class="mode-icon test">
                              <i data-lucide="flask-conical"></i>
                            </div>
                            <div class="mode-info">
                              <h4>Test Mode</h4>
                              <p>Simulated data for testing at home</p>
                            </div>
                            <div class="mode-check">
                              <i data-lucide="check-circle-2"></i>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Current Status -->
                      <div class="environment-status-card" id="environment-status-card">
                        <div class="status-header">
                          <i data-lucide="info"></i>
                          <span>Current Status</span>
                        </div>
                        <div class="status-content" id="environment-status-content">
                          <p>Production mode active - using live data from SNMP gateway</p>
                        </div>
                      </div>

                      <!-- Test Mode Options (only visible in test mode) -->
                      <div class="test-mode-options" id="test-mode-options" style="display: none;">
                        <h4><i data-lucide="settings-2"></i> Test Mode Options</h4>

                        <div class="test-option-group">
                          <label class="test-option">
                            <input type="checkbox" id="test-simulate-devices" checked>
                            <span class="checkmark"></span>
                            <div class="option-text">
                              <strong>Simulate Devices</strong>
                              <small>Create virtual devices with random status</small>
                            </div>
                          </label>

                          <label class="test-option">
                            <input type="checkbox" id="test-simulate-traps" checked>
                            <span class="checkmark"></span>
                            <div class="option-text">
                              <strong>Simulate SNMP Traps</strong>
                              <small>Generate random alerts (paper jam, toner low, etc.)</small>
                            </div>
                          </label>

                          <label class="test-option">
                            <input type="checkbox" id="test-simulate-supplies">
                            <span class="checkmark"></span>
                            <div class="option-text">
                              <strong>Simulate Supply Changes</strong>
                              <small>Gradually decrease supply levels over time</small>
                            </div>
                          </label>
                        </div>

                        <div class="test-actions">
                          <button type="button" class="btn btn-primary" onclick="generateTestTrap()">
                            <i data-lucide="zap"></i> Generate Test Trap
                          </button>
                          <button type="button" class="btn btn-outline" onclick="generateMultipleTestTraps()">
                            <i data-lucide="layers"></i> Generate 5 Random Traps
                          </button>
                          <button type="button" class="btn btn-ghost" onclick="clearTestData()">
                            <i data-lucide="trash-2"></i> Clear Test Data
                          </button>
                        </div>
                      </div>

                      <!-- Environment Indicator Banner -->
                      <div class="environment-banner test-banner" id="test-mode-banner" style="display: none;">
                        <i data-lucide="alert-triangle"></i>
                        <span>TEST MODE ACTIVE - Data is simulated and not real</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Theme Customization Section -->
                <div class="settings-panel" id="settings-panel-theme">
                  <div class="settings-section theme-section">
                    <h2 class="section-title"><i data-lucide="palette"></i> Theme Customization</h2>
                    <p class="section-desc">Customize colors, fonts, and appearance of your dashboard</p>

              <div class="theme-customization-panel">
                <!-- Preset Themes -->
                <div class="theme-subsection">
                  <h4><i data-lucide="swatches"></i> Preset Themes</h4>

                  <p class="theme-category-label">‚ú® Modern Light</p>
                  <div class="preset-themes-grid">
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('default')" data-theme="default">
                      <div class="preset-preview default-preview"></div>
                      <span>Default</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('glass')" data-theme="glass">
                      <div class="preset-preview glass-preview"></div>
                      <span>Glass</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('notion')" data-theme="notion">
                      <div class="preset-preview notion-preview"></div>
                      <span>Notion</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('linear')" data-theme="linear">
                      <div class="preset-preview linear-preview"></div>
                      <span>Linear</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('vercel')" data-theme="vercel">
                      <div class="preset-preview vercel-preview"></div>
                      <span>Vercel</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('stripe')" data-theme="stripe">
                      <div class="preset-preview stripe-preview"></div>
                      <span>Stripe</span>
                    </button>
                  </div>

                  <p class="theme-category-label">üåô Modern Dark</p>
                  <div class="preset-themes-grid">
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('obsidian')" data-theme="obsidian">
                      <div class="preset-preview obsidian-preview"></div>
                      <span>Obsidian</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('github-dark')" data-theme="github-dark">
                      <div class="preset-preview github-dark-preview"></div>
                      <span>GitHub</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('vscode')" data-theme="vscode">
                      <div class="preset-preview vscode-preview"></div>
                      <span>VS Code</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('discord')" data-theme="discord">
                      <div class="preset-preview discord-preview"></div>
                      <span>Discord</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('spotify')" data-theme="spotify">
                      <div class="preset-preview spotify-preview"></div>
                      <span>Spotify</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('slack')" data-theme="slack">
                      <div class="preset-preview slack-preview"></div>
                      <span>Slack</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('extreme')" data-theme="extreme">
                      <div class="preset-preview extreme-preview"></div>
                      <span>Extreme</span>
                    </button>
                  </div>

                  <p class="theme-category-label">üé® Gradient & Trendy</p>
                  <div class="preset-themes-grid">
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('aurora-glow')" data-theme="aurora-glow">
                      <div class="preset-preview aurora-glow-preview"></div>
                      <span>Aurora</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('sunset-dream')" data-theme="sunset-dream">
                      <div class="preset-preview sunset-dream-preview"></div>
                      <span>Sunset</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('ocean-breeze')" data-theme="ocean-breeze">
                      <div class="preset-preview ocean-breeze-preview"></div>
                      <span>Ocean</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('berry-blast')" data-theme="berry-blast">
                      <div class="preset-preview berry-blast-preview"></div>
                      <span>Berry</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('mint-fresh')" data-theme="mint-fresh">
                      <div class="preset-preview mint-fresh-preview"></div>
                      <span>Mint</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('lavender-mist')" data-theme="lavender-mist">
                      <div class="preset-preview lavender-mist-preview"></div>
                      <span>Lavender</span>
                    </button>
                  </div>

                  <p class="theme-category-label">üíº Professional</p>
                  <div class="preset-themes-grid">
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('corporate')" data-theme="corporate">
                      <div class="preset-preview corporate-preview"></div>
                      <span>Corporate</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('executive')" data-theme="executive">
                      <div class="preset-preview executive-preview"></div>
                      <span>Executive</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('finance')" data-theme="finance">
                      <div class="preset-preview finance-preview"></div>
                      <span>Finance</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('healthcare')" data-theme="healthcare">
                      <div class="preset-preview healthcare-preview"></div>
                      <span>Healthcare</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('legal')" data-theme="legal">
                      <div class="preset-preview legal-preview"></div>
                      <span>Legal</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('education')" data-theme="education">
                      <div class="preset-preview education-preview"></div>
                      <span>Education</span>
                    </button>
                  </div>

                  <p class="theme-category-label">üåø Nature</p>
                  <div class="preset-themes-grid">
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('forest')" data-theme="forest">
                      <div class="preset-preview forest-preview"></div>
                      <span>Forest</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('ocean')" data-theme="ocean">
                      <div class="preset-preview ocean-preview"></div>
                      <span>Ocean</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('desert')" data-theme="desert">
                      <div class="preset-preview desert-preview"></div>
                      <span>Desert</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('mountain')" data-theme="mountain">
                      <div class="preset-preview mountain-preview"></div>
                      <span>Mountain</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('sunset')" data-theme="sunset">
                      <div class="preset-preview sunset-preview"></div>
                      <span>Sunset</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('sakura')" data-theme="sakura">
                      <div class="preset-preview sakura-preview"></div>
                      <span>Sakura</span>
                    </button>
                  </div>

                  <p class="theme-category-label">üéÆ Tech & Gaming</p>
                  <div class="preset-themes-grid">
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('cyberpunk')" data-theme="cyberpunk">
                      <div class="preset-preview cyberpunk-preview"></div>
                      <span>Cyberpunk</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('matrix')" data-theme="matrix">
                      <div class="preset-preview matrix-preview"></div>
                      <span>Matrix</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('retro')" data-theme="retro">
                      <div class="preset-preview retro-preview"></div>
                      <span>Retro</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('synthwave')" data-theme="synthwave">
                      <div class="preset-preview synthwave-preview"></div>
                      <span>Synthwave</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('hacker')" data-theme="hacker">
                      <div class="preset-preview hacker-preview"></div>
                      <span>Hacker</span>
                    </button>
                    <button type="button" class="preset-theme-btn" onclick="applyPresetTheme('neon')" data-theme="neon">
                      <div class="preset-preview neon-preview"></div>
                      <span>Neon</span>
                    </button>
                  </div>
                </div>

                <!-- Brand Colors -->
                <div class="theme-subsection">
                  <h4><i data-lucide="droplet"></i> Brand Colors</h4>
                  <div class="color-pickers-grid">
                    <div class="color-picker-group">
                      <label>Primary Color</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-primary" value="#6366f1" onchange="updateThemeColor('primary', this.value)">
                        <input type="text" id="theme-primary-hex" value="#6366f1" onchange="updateThemeColorFromHex('primary', this.value)">
                      </div>
                      <small>Buttons, links, active states</small>
                    </div>
                    <div class="color-picker-group">
                      <label>Secondary Color</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-secondary" value="#64748b" onchange="updateThemeColor('secondary', this.value)">
                        <input type="text" id="theme-secondary-hex" value="#64748b" onchange="updateThemeColorFromHex('secondary', this.value)">
                      </div>
                      <small>Secondary text, borders</small>
                    </div>
                    <div class="color-picker-group">
                      <label>Accent Color</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-accent" value="#f59e0b" onchange="updateThemeColor('accent', this.value)">
                        <input type="text" id="theme-accent-hex" value="#f59e0b" onchange="updateThemeColorFromHex('accent', this.value)">
                      </div>
                      <small>Highlights, badges</small>
                    </div>
                  </div>
                </div>

                <!-- Status Colors -->
                <div class="theme-subsection">
                  <h4><i data-lucide="circle-dot"></i> Status Colors</h4>
                  <div class="color-pickers-grid">
                    <div class="color-picker-group">
                      <label>Success (Online)</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-success" value="#22c55e" onchange="updateThemeColor('success', this.value)">
                        <input type="text" id="theme-success-hex" value="#22c55e" onchange="updateThemeColorFromHex('success', this.value)">
                      </div>
                    </div>
                    <div class="color-picker-group">
                      <label>Warning</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-warning" value="#f59e0b" onchange="updateThemeColor('warning', this.value)">
                        <input type="text" id="theme-warning-hex" value="#f59e0b" onchange="updateThemeColorFromHex('warning', this.value)">
                      </div>
                    </div>
                    <div class="color-picker-group">
                      <label>Danger (Error/Offline)</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-danger" value="#ef4444" onchange="updateThemeColor('danger', this.value)">
                        <input type="text" id="theme-danger-hex" value="#ef4444" onchange="updateThemeColorFromHex('danger', this.value)">
                      </div>
                    </div>
                    <div class="color-picker-group">
                      <label>Info</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-info" value="#3b82f6" onchange="updateThemeColor('info', this.value)">
                        <input type="text" id="theme-info-hex" value="#3b82f6" onchange="updateThemeColorFromHex('info', this.value)">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Background Colors -->
                <div class="theme-subsection">
                  <h4><i data-lucide="layers"></i> Background Colors</h4>
                  <div class="color-pickers-grid">
                    <div class="color-picker-group">
                      <label>Main Background</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-bg-primary" value="#ffffff" onchange="updateThemeColor('bg-primary', this.value)">
                        <input type="text" id="theme-bg-primary-hex" value="#ffffff" onchange="updateThemeColorFromHex('bg-primary', this.value)">
                      </div>
                    </div>
                    <div class="color-picker-group">
                      <label>Secondary Background</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-bg-secondary" value="#f8fafc" onchange="updateThemeColor('bg-secondary', this.value)">
                        <input type="text" id="theme-bg-secondary-hex" value="#f8fafc" onchange="updateThemeColorFromHex('bg-secondary', this.value)">
                      </div>
                    </div>
                    <div class="color-picker-group">
                      <label>Tertiary Background</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-bg-tertiary" value="#f1f5f9" onchange="updateThemeColor('bg-tertiary', this.value)">
                        <input type="text" id="theme-bg-tertiary-hex" value="#f1f5f9" onchange="updateThemeColorFromHex('bg-tertiary', this.value)">
                      </div>
                    </div>
                    <div class="color-picker-group">
                      <label>Sidebar Background</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-sidebar-bg" value="#1e293b" onchange="updateThemeColor('sidebar-bg', this.value)">
                        <input type="text" id="theme-sidebar-bg-hex" value="#1e293b" onchange="updateThemeColorFromHex('sidebar-bg', this.value)">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Text Colors -->
                <div class="theme-subsection">
                  <h4><i data-lucide="type"></i> Text Colors</h4>
                  <div class="color-pickers-grid">
                    <div class="color-picker-group">
                      <label>Primary Text</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-text-primary" value="#0f172a" onchange="updateThemeColor('text-primary', this.value)">
                        <input type="text" id="theme-text-primary-hex" value="#0f172a" onchange="updateThemeColorFromHex('text-primary', this.value)">
                      </div>
                    </div>
                    <div class="color-picker-group">
                      <label>Secondary Text</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-text-secondary" value="#475569" onchange="updateThemeColor('text-secondary', this.value)">
                        <input type="text" id="theme-text-secondary-hex" value="#475569" onchange="updateThemeColorFromHex('text-secondary', this.value)">
                      </div>
                    </div>
                    <div class="color-picker-group">
                      <label>Muted Text</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-text-muted" value="#94a3b8" onchange="updateThemeColor('text-muted', this.value)">
                        <input type="text" id="theme-text-muted-hex" value="#94a3b8" onchange="updateThemeColorFromHex('text-muted', this.value)">
                      </div>
                    </div>
                    <div class="color-picker-group">
                      <label>Border Color</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-border" value="#e2e8f0" onchange="updateThemeColor('border', this.value)">
                        <input type="text" id="theme-border-hex" value="#e2e8f0" onchange="updateThemeColorFromHex('border', this.value)">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Typography -->
                <div class="theme-subsection">
                  <h4><i data-lucide="text"></i> Typography</h4>
                  <div class="typography-settings">
                    <div class="form-group">
                      <label>Font Family</label>
                      <select id="theme-font-family" onchange="updateThemeFont(this.value)">
                        <option value="'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif">Inter (Default)</option>
                        <option value="'Roboto', sans-serif">Roboto</option>
                        <option value="'Open Sans', sans-serif">Open Sans</option>
                        <option value="'Lato', sans-serif">Lato</option>
                        <option value="'Poppins', sans-serif">Poppins</option>
                        <option value="'Montserrat', sans-serif">Montserrat</option>
                        <option value="'Source Sans Pro', sans-serif">Source Sans Pro</option>
                        <option value="'Nunito', sans-serif">Nunito</option>
                        <option value="system-ui, sans-serif">System UI</option>
                        <option value="'Georgia', serif">Georgia (Serif)</option>
                        <option value="'Courier New', monospace">Courier (Monospace)</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Base Font Size</label>
                      <select id="theme-font-size" onchange="updateThemeFontSize(this.value)">
                        <option value="14px">Small (14px)</option>
                        <option value="16px" selected>Medium (16px)</option>
                        <option value="18px">Large (18px)</option>
                        <option value="20px">Extra Large (20px)</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Heading Font Weight</label>
                      <select id="theme-heading-weight" onchange="updateThemeHeadingWeight(this.value)">
                        <option value="400">Normal (400)</option>
                        <option value="500">Medium (500)</option>
                        <option value="600" selected>Semi-Bold (600)</option>
                        <option value="700">Bold (700)</option>
                        <option value="800">Extra Bold (800)</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- UI Elements -->
                <div class="theme-subsection">
                  <h4><i data-lucide="square-stack"></i> UI Elements</h4>
                  <div class="ui-settings">
                    <div class="form-group">
                      <label>Border Radius</label>
                      <select id="theme-radius" onchange="updateThemeRadius(this.value)">
                        <option value="0px">None (Square)</option>
                        <option value="4px">Small (4px)</option>
                        <option value="8px">Medium (8px)</option>
                        <option value="12px" selected>Large (12px)</option>
                        <option value="16px">Extra Large (16px)</option>
                        <option value="24px">Rounded (24px)</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Shadow Intensity</label>
                      <select id="theme-shadow" onchange="updateThemeShadow(this.value)">
                        <option value="none">None</option>
                        <option value="light">Light</option>
                        <option value="medium" selected>Medium</option>
                        <option value="heavy">Heavy</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Sidebar Width</label>
                      <select id="theme-sidebar-width" onchange="updateThemeSidebarWidth(this.value)">
                        <option value="220px">Narrow (220px)</option>
                        <option value="260px" selected>Normal (260px)</option>
                        <option value="300px">Wide (300px)</option>
                        <option value="340px">Extra Wide (340px)</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Header Customization -->
                <div class="theme-subsection">
                  <h4><i data-lucide="layout-template"></i> Header & Branding</h4>
                  <div class="branding-settings">
                    <div class="form-group">
                      <label>App Title</label>
                      <input type="text" id="theme-app-title" value="Smart School Monitor" onchange="updateAppTitle(this.value)">
                    </div>
                    <div class="form-group">
                      <label>App Subtitle</label>
                      <input type="text" id="theme-app-subtitle" value="SNMP Network Monitoring System" onchange="updateAppSubtitle(this.value)">
                    </div>
                    <div class="form-group">
                      <label>Header Background</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-header-bg" value="#ffffff" onchange="updateThemeColor('header-bg', this.value)">
                        <input type="text" id="theme-header-bg-hex" value="#ffffff" onchange="updateThemeColorFromHex('header-bg', this.value)">
                      </div>
                    </div>
                    <div class="form-group">
                      <label>Title Color</label>
                      <div class="color-input-wrapper">
                        <input type="color" id="theme-title-color" value="#6366f1" onchange="updateThemeColor('title-color', this.value)">
                        <input type="text" id="theme-title-color-hex" value="#6366f1" onchange="updateThemeColorFromHex('title-color', this.value)">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Theme Actions -->
                <div class="theme-actions">
                  <button type="button" class="btn btn-outline" onclick="resetThemeToDefault()">
                    <i data-lucide="rotate-ccw"></i> Reset to Default
                  </button>
                  <button type="button" class="btn btn-outline" onclick="exportTheme()">
                    <i data-lucide="download"></i> Export Theme
                  </button>
                  <button type="button" class="btn btn-outline" onclick="document.getElementById('theme-import').click()">
                    <i data-lucide="upload"></i> Import Theme
                  </button>
                  <input type="file" id="theme-import" accept=".json" style="display:none" onchange="importTheme(event)">
                  <button type="button" class="btn btn-primary" onclick="saveTheme()">
                    <i data-lucide="save"></i> Save Theme
                  </button>
                </div>
              </div>
                  </div>
                </div>

                <!-- Splash Screen Customization Section -->
                <div class="settings-panel" id="settings-panel-splash-screen">
                  <div class="settings-section">
                    <h2 class="section-title"><i data-lucide="layout-template"></i> Splash Screen Customization</h2>
                    <p class="section-desc">Customize the loading screen appearance including icon, title, and background.</p>

                    <!-- Live Preview -->
                    <div class="splash-preview-container">
                      <div class="splash-preview" id="splash-preview">
                        <div class="splash-preview-icon" id="splash-preview-icon">üè´</div>
                        <h2 class="splash-preview-title" id="splash-preview-title">Smart School Monitor</h2>
                        <p class="splash-preview-subtitle">Loading your network dashboard...</p>
                        <div class="splash-preview-loader"></div>
                      </div>
                    </div>

                    <!-- Title Customization -->
                    <div class="splash-setting-card">
                      <h4><i data-lucide="type"></i> Page Title</h4>
                      <div class="form-group">
                        <label>Application Title</label>
                        <input type="text" id="splash-title" class="form-control" value="Smart School Monitor" placeholder="Enter your title..." oninput="updateSplashPreview()">
                      </div>
                      <div class="form-group">
                        <label>Loading Text</label>
                        <input type="text" id="splash-subtitle" class="form-control" value="Loading your network dashboard..." placeholder="Enter loading text..." oninput="updateSplashPreview()">
                      </div>
                    </div>

                    <!-- Icon Selection -->
                    <div class="splash-setting-card">
                      <h4><i data-lucide="image"></i> Splash Icon</h4>
                      <p class="subsection-desc">Choose from default icons or upload your own</p>

                      <!-- Default Icons -->
                      <div class="splash-icons-grid">
                        <button type="button" class="splash-icon-btn active" onclick="selectSplashIcon('üè´')" data-icon="üè´">üè´</button>
                        <button type="button" class="splash-icon-btn" onclick="selectSplashIcon('üñ®Ô∏è')" data-icon="üñ®Ô∏è">üñ®Ô∏è</button>
                        <button type="button" class="splash-icon-btn" onclick="selectSplashIcon('üìä')" data-icon="üìä">üìä</button>
                        <button type="button" class="splash-icon-btn" onclick="selectSplashIcon('üñ•Ô∏è')" data-icon="üñ•Ô∏è">üñ•Ô∏è</button>
                        <button type="button" class="splash-icon-btn" onclick="selectSplashIcon('üì°')" data-icon="üì°">üì°</button>
                        <button type="button" class="splash-icon-btn" onclick="selectSplashIcon('üîß')" data-icon="üîß">üîß</button>
                        <button type="button" class="splash-icon-btn" onclick="selectSplashIcon('‚öôÔ∏è')" data-icon="‚öôÔ∏è">‚öôÔ∏è</button>
                        <button type="button" class="splash-icon-btn" onclick="selectSplashIcon('üéì')" data-icon="üéì">üéì</button>
                        <button type="button" class="splash-icon-btn" onclick="selectSplashIcon('üìö')" data-icon="üìö">üìö</button>
                        <button type="button" class="splash-icon-btn" onclick="selectSplashIcon('üè¢')" data-icon="üè¢">üè¢</button>
                        <button type="button" class="splash-icon-btn" onclick="selectSplashIcon('üåê')" data-icon="üåê">üåê</button>
                        <button type="button" class="splash-icon-btn" onclick="selectSplashIcon('üíª')" data-icon="üíª">üíª</button>
                      </div>

                      <!-- Custom Icon Upload -->
                      <div class="custom-icon-upload">
                        <label>Or upload custom icon:</label>
                        <div class="upload-row">
                          <input type="file" id="splash-icon-upload" accept="image/*" style="display:none" onchange="handleSplashIconUpload(event)">
                          <button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('splash-icon-upload').click()">
                            <i data-lucide="upload"></i> Upload Image
                          </button>
                          <span id="splash-icon-filename" class="upload-filename"></span>
                        </div>
                      </div>
                    </div>

                    <!-- Background Color -->
                    <div class="splash-setting-card">
                      <h4><i data-lucide="paintbrush"></i> Background Color</h4>
                      <p class="subsection-desc">Choose a pastel color for the splash screen background</p>

                      <div class="splash-colors-grid">
                        <!-- Pastel Colors -->
                        <button type="button" class="splash-color-btn active" onclick="selectSplashColor('#7c6fdc')" style="background: #7c6fdc" data-color="#7c6fdc" title="Purple (Default)"></button>
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#6b8cce')" style="background: #6b8cce" data-color="#6b8cce" title="Blue"></button>
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#5da5a8')" style="background: #5da5a8" data-color="#5da5a8" title="Teal"></button>
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#6bc08f')" style="background: #6bc08f" data-color="#6bc08f" title="Green"></button>
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#f0b86e')" style="background: #f0b86e" data-color="#f0b86e" title="Orange"></button>
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#e88a8a')" style="background: #e88a8a" data-color="#e88a8a" title="Coral"></button>
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#d88bc4')" style="background: #d88bc4" data-color="#d88bc4" title="Pink"></button>
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#9b8cd1')" style="background: #9b8cd1" data-color="#9b8cd1" title="Lavender"></button>
                        <!-- More Pastels -->
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#a8d8ea')" style="background: #a8d8ea" data-color="#a8d8ea" title="Sky Blue"></button>
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#aa96da')" style="background: #aa96da" data-color="#aa96da" title="Soft Purple"></button>
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#fcbad3')" style="background: #fcbad3" data-color="#fcbad3" title="Light Pink"></button>
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#ffffd2')" style="background: #ffffd2; border: 1px solid #ddd" data-color="#ffffd2" title="Cream"></button>
                        <!-- Dark Options -->
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#2d3436')" style="background: #2d3436" data-color="#2d3436" title="Dark Gray"></button>
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#1e272e')" style="background: #1e272e" data-color="#1e272e" title="Charcoal"></button>
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#0a3d62')" style="background: #0a3d62" data-color="#0a3d62" title="Navy"></button>
                        <button type="button" class="splash-color-btn" onclick="selectSplashColor('#6a0572')" style="background: #6a0572" data-color="#6a0572" title="Deep Purple"></button>
                      </div>

                      <!-- Custom Color -->
                      <div class="custom-color-row">
                        <label>Custom color:</label>
                        <input type="color" id="splash-custom-color" value="#7c6fdc" onchange="selectSplashColor(this.value)">
                      </div>
                    </div>

                    <!-- Background Pattern -->
                    <div class="splash-setting-card">
                      <h4><i data-lucide="grid-3x3"></i> Background Pattern</h4>
                      <p class="subsection-desc">Add an abstract pattern overlay to the background</p>

                      <div class="splash-patterns-grid">
                        <button type="button" class="splash-pattern-btn active" onclick="selectSplashPattern('none')" data-pattern="none">
                          <div class="pattern-preview pattern-none"></div>
                          <span>None</span>
                        </button>
                        <button type="button" class="splash-pattern-btn" onclick="selectSplashPattern('dots')" data-pattern="dots">
                          <div class="pattern-preview pattern-dots"></div>
                          <span>Dots</span>
                        </button>
                        <button type="button" class="splash-pattern-btn" onclick="selectSplashPattern('grid')" data-pattern="grid">
                          <div class="pattern-preview pattern-grid"></div>
                          <span>Grid</span>
                        </button>
                        <button type="button" class="splash-pattern-btn" onclick="selectSplashPattern('waves')" data-pattern="waves">
                          <div class="pattern-preview pattern-waves"></div>
                          <span>Waves</span>
                        </button>
                        <button type="button" class="splash-pattern-btn" onclick="selectSplashPattern('circles')" data-pattern="circles">
                          <div class="pattern-preview pattern-circles"></div>
                          <span>Circles</span>
                        </button>
                        <button type="button" class="splash-pattern-btn" onclick="selectSplashPattern('diagonal')" data-pattern="diagonal">
                          <div class="pattern-preview pattern-diagonal"></div>
                          <span>Diagonal</span>
                        </button>
                        <button type="button" class="splash-pattern-btn" onclick="selectSplashPattern('hexagon')" data-pattern="hexagon">
                          <div class="pattern-preview pattern-hexagon"></div>
                          <span>Hexagon</span>
                        </button>
                        <button type="button" class="splash-pattern-btn" onclick="selectSplashPattern('gradient')" data-pattern="gradient">
                          <div class="pattern-preview pattern-gradient"></div>
                          <span>Gradient</span>
                        </button>
                      </div>
                    </div>

                    <!-- Actions -->
                    <div class="splash-actions">
                      <button type="button" class="btn btn-primary" onclick="saveSplashSettings()">
                        <i data-lucide="save"></i> Save Settings
                      </button>
                      <button type="button" class="btn btn-outline" onclick="resetSplashSettings()">
                        <i data-lucide="rotate-ccw"></i> Reset to Default
                      </button>
                    </div>

                  </div>
                </div>

                <!-- Icon Customization Section -->
                <div class="settings-panel" id="settings-panel-icons">
                  <div class="settings-section icons-section">
                    <h2 class="section-title"><i data-lucide="shapes"></i> Icon Customization</h2>
                    <p class="section-desc">Customize icons used throughout the application. Upload your own icons or select from the icon library.</p>

              <div class="icon-customization-panel">
                <!-- Custom Icons Upload -->
                <div class="theme-subsection">
                  <h4><i data-lucide="upload"></i> Upload Custom Icons</h4>
                  <p class="subsection-desc">Upload your own PNG, SVG, or JPG icons (recommended size: 64x64 or larger)</p>

                  <div class="custom-icons-upload">
                    <div class="upload-dropzone" id="icon-dropzone" onclick="document.getElementById('icon-file-input').click()">
                      <i data-lucide="image-plus"></i>
                      <span>Click or drag icons here to upload</span>
                      <small>PNG, SVG, or JPG - Max 500KB each</small>
                    </div>
                    <input type="file" id="icon-file-input" accept="image/*" multiple style="display:none" onchange="uploadCustomIcons(event)">
                  </div>

                  <div class="custom-icons-library" id="custom-icons-library">
                    <h5>Your Custom Icons</h5>
                    <div class="custom-icons-grid" id="custom-icons-grid">
                      <div class="no-icons-message">No custom icons uploaded yet</div>
                    </div>
                  </div>
                </div>

                <!-- App Element Icons -->
                <div class="theme-subsection">
                  <h4><i data-lucide="layout"></i> App Element Icons</h4>
                  <p class="subsection-desc">Choose icons for different elements in the app</p>

                  <div class="icon-assignments">
                    <div class="icon-assignment-row">
                      <label>App Logo / Header Icon</label>
                      <div class="icon-selector">
                        <button type="button" class="icon-preview-btn" id="icon-app-logo-btn" onclick="showIconPicker('app-logo')">
                          <i data-lucide="monitor"></i>
                        </button>
                        <input type="hidden" id="icon-app-logo" value="monitor">
                        <span class="icon-name" id="icon-app-logo-name">monitor</span>
                      </div>
                    </div>

                    <div class="icon-assignment-row">
                      <label>Dashboard Icon</label>
                      <div class="icon-selector">
                        <button type="button" class="icon-preview-btn" id="icon-dashboard-btn" onclick="showIconPicker('dashboard')">
                          <i data-lucide="layout-dashboard"></i>
                        </button>
                        <input type="hidden" id="icon-dashboard" value="layout-dashboard">
                        <span class="icon-name" id="icon-dashboard-name">layout-dashboard</span>
                      </div>
                    </div>

                    <div class="icon-assignment-row">
                      <label>Devices Icon</label>
                      <div class="icon-selector">
                        <button type="button" class="icon-preview-btn" id="icon-devices-btn" onclick="showIconPicker('devices')">
                          <i data-lucide="printer"></i>
                        </button>
                        <input type="hidden" id="icon-devices" value="printer">
                        <span class="icon-name" id="icon-devices-name">printer</span>
                      </div>
                    </div>

                    <div class="icon-assignment-row">
                      <label>Alerts Icon</label>
                      <div class="icon-selector">
                        <button type="button" class="icon-preview-btn" id="icon-alerts-btn" onclick="showIconPicker('alerts')">
                          <i data-lucide="bell"></i>
                        </button>
                        <input type="hidden" id="icon-alerts" value="bell">
                        <span class="icon-name" id="icon-alerts-name">bell</span>
                      </div>
                    </div>

                    <div class="icon-assignment-row">
                      <label>Service Requests Icon</label>
                      <div class="icon-selector">
                        <button type="button" class="icon-preview-btn" id="icon-service-btn" onclick="showIconPicker('service')">
                          <i data-lucide="wrench"></i>
                        </button>
                        <input type="hidden" id="icon-service" value="wrench">
                        <span class="icon-name" id="icon-service-name">wrench</span>
                      </div>
                    </div>

                    <div class="icon-assignment-row">
                      <label>Settings Icon</label>
                      <div class="icon-selector">
                        <button type="button" class="icon-preview-btn" id="icon-settings-btn" onclick="showIconPicker('settings')">
                          <i data-lucide="settings"></i>
                        </button>
                        <input type="hidden" id="icon-settings" value="settings">
                        <span class="icon-name" id="icon-settings-name">settings</span>
                      </div>
                    </div>

                    <div class="icon-assignment-row">
                      <label>Online Status Icon</label>
                      <div class="icon-selector">
                        <button type="button" class="icon-preview-btn" id="icon-online-btn" onclick="showIconPicker('online')">
                          <i data-lucide="check-circle"></i>
                        </button>
                        <input type="hidden" id="icon-online" value="check-circle">
                        <span class="icon-name" id="icon-online-name">check-circle</span>
                      </div>
                    </div>

                    <div class="icon-assignment-row">
                      <label>Offline Status Icon</label>
                      <div class="icon-selector">
                        <button type="button" class="icon-preview-btn" id="icon-offline-btn" onclick="showIconPicker('offline')">
                          <i data-lucide="x-circle"></i>
                        </button>
                        <input type="hidden" id="icon-offline" value="x-circle">
                        <span class="icon-name" id="icon-offline-name">x-circle</span>
                      </div>
                    </div>

                    <div class="icon-assignment-row">
                      <label>Warning/Alert Icon</label>
                      <div class="icon-selector">
                        <button type="button" class="icon-preview-btn" id="icon-warning-btn" onclick="showIconPicker('warning')">
                          <i data-lucide="alert-triangle"></i>
                        </button>
                        <input type="hidden" id="icon-warning" value="alert-triangle">
                        <span class="icon-name" id="icon-warning-name">alert-triangle</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Device Type Icons -->
                <div class="theme-subsection">
                  <h4><i data-lucide="box"></i> Device Type Icons</h4>
                  <p class="subsection-desc">Assign icons to device types (set when editing device types)</p>

                  <div class="device-type-icons-grid" id="device-type-icons-grid">
                    <!-- Populated dynamically -->
                    <div class="loading-message">Loading device types...</div>
                  </div>
                </div>

                <!-- Icon Library Preview -->
                <div class="theme-subsection">
                  <h4><i data-lucide="grid-3x3"></i> Available Icons Library</h4>
                  <p class="subsection-desc">Browse available Lucide icons</p>

                  <div class="icon-search-wrapper">
                    <input type="text" id="icon-library-search" placeholder="Search icons..." oninput="filterIconLibrary(this.value)">
                  </div>

                  <div class="icon-library-categories">
                    <button type="button" class="category-btn active" onclick="filterIconCategory('all')">All</button>
                    <button type="button" class="category-btn" onclick="filterIconCategory('devices')">Devices</button>
                    <button type="button" class="category-btn" onclick="filterIconCategory('status')">Status</button>
                    <button type="button" class="category-btn" onclick="filterIconCategory('actions')">Actions</button>
                    <button type="button" class="category-btn" onclick="filterIconCategory('navigation')">Navigation</button>
                    <button type="button" class="category-btn" onclick="filterIconCategory('alerts')">Alerts</button>
                  </div>

                  <div class="icon-library-grid" id="icon-library-grid">
                    <!-- Populated dynamically with Lucide icons -->
                  </div>
                </div>

                <!-- Icon Actions -->
                <div class="theme-actions">
                  <button type="button" class="btn btn-outline" onclick="resetIconsToDefault()">
                    <i data-lucide="rotate-ccw"></i> Reset to Default
                  </button>
                  <button type="button" class="btn btn-outline" onclick="exportIconSettings()">
                    <i data-lucide="download"></i> Export Icons
                  </button>
                  <button type="button" class="btn btn-outline" onclick="document.getElementById('icon-import').click()">
                    <i data-lucide="upload"></i> Import Icons
                  </button>
                  <input type="file" id="icon-import" accept=".json" style="display:none" onchange="importIconSettings(event)">
                  <button type="button" class="btn btn-primary" onclick="saveIconSettings()">
                    <i data-lucide="save"></i> Save Icons
                  </button>
                </div>
              </div>
            </div>

            <!-- Icon Picker Modal -->
            <div id="icon-picker-modal" class="modal" style="display:none;">
              <div class="modal-backdrop" onclick="closeIconPicker()"></div>
              <div class="modal-content icon-picker-modal-content">
                <div class="modal-header">
                  <h3><i data-lucide="grid-3x3"></i> Select Icon</h3>
                  <button type="button" class="modal-close" onclick="closeIconPicker()">&times;</button>
                </div>
                <div class="modal-body">
                  <input type="text" id="icon-picker-search" placeholder="Search icons..." oninput="filterPickerIcons(this.value)">

                  <div class="icon-picker-tabs">
                    <button type="button" class="picker-tab active" onclick="switchPickerTab('lucide')">Lucide Icons</button>
                    <button type="button" class="picker-tab" onclick="switchPickerTab('custom')">Custom Icons</button>
                  </div>

                      <div class="icon-picker-grid" id="icon-picker-grid">
                        <!-- Populated dynamically -->
                      </div>
                    </div>
                  </div>
                  </div>
                </div>

                <!-- Teachers Management Section -->
                <div class="settings-panel" id="settings-panel-teachers">
                  <div class="settings-section teachers-section">
                    <h2 class="section-title"><i data-lucide="graduation-cap"></i> Teachers</h2>
                    <p class="section-desc">Manage teacher information including Employee ID, Name, Email, and Room Number</p>

              <div class="teachers-header">
                <div class="teachers-stats">
                  <span id="teachers-count">0 teachers</span>
                </div>
                <div class="teachers-actions">
                  <button type="button" class="btn btn-outline btn-sm" onclick="triggerCSVUpload()">
                    <i data-lucide="upload"></i> Import CSV
                  </button>
                  <button type="button" class="btn btn-outline btn-sm" onclick="exportTeachersCSV()">
                    <i data-lucide="download"></i> Export CSV
                  </button>
                  <button type="button" class="btn btn-danger btn-sm" onclick="confirmDeleteAllTeachers()">
                    <i data-lucide="trash-2"></i> Delete All
                  </button>
                  <button type="button" class="btn btn-primary" onclick="showAddTeacherModal()">
                    <i data-lucide="user-plus"></i> Add Teacher
                  </button>
                </div>
              </div>

              <!-- Search and Filter -->
              <div class="teachers-search">
                <div class="search-input-wrapper">
                  <i data-lucide="search"></i>
                  <input type="text" id="teacher-search" placeholder="Search by name, email, or room..." oninput="filterTeachers()">
                </div>
              </div>

              <!-- Teachers Table -->
              <div class="teachers-table-container">
                <table class="teachers-table">
                  <thead>
                    <tr>
                      <th>Emp ID</th>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Room Number</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="teachers-table-body">
                    <tr class="empty-row">
                      <td colspan="5">
                        <div class="empty-state">
                          <i data-lucide="users"></i>
                          <p>No teachers added yet</p>
                          <button type="button" class="btn btn-primary btn-sm" onclick="showAddTeacherModal()">Add First Teacher</button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
                  </div>
                </div>

                <!-- Device Types Management Section -->
                <div class="settings-panel" id="settings-panel-device-types">
                  <div class="settings-section device-types-section">
                    <h2 class="section-title"><i data-lucide="layers"></i> Device Types</h2>
                    <p class="section-desc">Configure device types (Copier, Smartboard, etc.) and their settings</p>

              <div class="device-types-header">
                <span id="device-types-count">0 device types</span>
                <button type="button" class="btn btn-primary" onclick="openAddDeviceTypeModal()">
                  <i data-lucide="plus"></i> Add Device Type
                </button>
              </div>

              <div class="device-types-table-container">
                <table class="device-types-table">
                  <thead>
                    <tr>
                      <th style="width: 60px;">Icon</th>
                      <th>Name</th>
                      <th>Description</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="device-types-table-body">
                    <tr><td colspan="5" class="empty-message">Loading device types...</td></tr>
                  </tbody>
                </table>
              </div>
                  </div>
                </div>

                <!-- Issue Buttons Management Section -->
                <div class="settings-panel" id="settings-panel-issue-buttons">
                  <div class="settings-section issue-buttons-section">
                    <h2 class="section-title"><i data-lucide="mouse-pointer-click"></i> Issue Buttons</h2>
                    <p class="section-desc">Configure the issue buttons that appear on each device type's request page</p>

              <div class="issue-buttons-header">
                <div class="filter-controls">
                  <label for="issue-buttons-filter-type">Filter by type:</label>
                  <select id="issue-buttons-filter-type" class="form-select" onchange="filterIssueButtons()">
                    <option value="">All Device Types</option>
                  </select>
                </div>
                <button type="button" class="btn btn-primary" onclick="openAddIssueButtonModal()">
                  <i data-lucide="plus"></i> Add Issue Button
                </button>
              </div>

              <div class="issue-buttons-table-container">
                <table class="issue-buttons-table">
                  <thead>
                    <tr>
                      <th>Device Type</th>
                      <th>Button Label</th>
                      <th>Priority</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="issue-buttons-table-body">
                    <tr><td colspan="5" class="empty-message">Loading issue buttons...</td></tr>
                  </tbody>
                </table>
              </div>
                  </div>
                </div>

                <!-- Repair Templates Management Section -->
                <div class="settings-panel" id="settings-panel-repair-templates">
                  <div class="settings-section">
                    <h2 class="section-title"><i data-lucide="layout-template"></i> Repair Templates</h2>
                    <p class="section-desc">Manage pre-filled ticket templates for recurring computer repair issues</p>

                    <div class="issue-buttons-header">
                      <div></div>
                      <button type="button" class="btn btn-primary" onclick="openRepairTemplateEditor()">
                        <i data-lucide="plus"></i> Add Template
                      </button>
                    </div>

                    <div id="repair-templates-list">
                      <p class="text-muted" style="padding:12px;">Loading templates...</p>
                    </div>
                  </div>
                </div>

                <!-- QR Codes Management Section -->
                <div class="settings-panel" id="settings-panel-qr-codes">
                  <div class="settings-section qr-codes-section">
                    <h2 class="section-title"><i data-lucide="qr-code"></i> QR Code Labels</h2>
                    <p class="section-desc">Design label layout and print QR code labels for Dymo LabelWriter</p>

                    <!-- Label Layout Editor V2 -->
                    <div class="label-editor-container">
                      <h3 class="subsection-title"><i data-lucide="layout"></i> Label Layout Editor</h3>

                      <!-- Toolbar -->
                      <div class="label-editor-toolbar">
                        <div class="toolbar-group">
                          <label>Label Size</label>
                          <select id="label-size-select" class="form-select" onchange="onLabelSizeChange()">
                            <option value="4x2.125">4" x 2.125" (Standard)</option>
                            <option value="3.5x1.125">3.5" x 1.125" (Address)</option>
                            <option value="2.125x4">2.125" x 4" (Shipping)</option>
                            <option value="1x2.125">1" x 2.125" (Small)</option>
                            <option value="custom">Custom...</option>
                          </select>
                        </div>
                        <div class="toolbar-group label-custom-size" id="label-custom-size" style="display:none;">
                          <label>W</label>
                          <input type="number" id="label-custom-w" class="form-input" style="width:60px" min="50" max="600" value="384" onchange="onCustomLabelSize()">
                          <label>H</label>
                          <input type="number" id="label-custom-h" class="form-input" style="width:60px" min="50" max="600" value="204" onchange="onCustomLabelSize()">
                          <span class="form-hint">px</span>
                        </div>
                        <div class="toolbar-group">
                          <label>Padding</label>
                          <input type="number" id="label-padding" class="form-input" style="width:50px" min="0" max="30" value="6" onchange="onLayoutToolbarChange()">
                        </div>
                        <div class="toolbar-group">
                          <label>Font</label>
                          <select id="label-font-family" class="form-select" onchange="onLayoutToolbarChange()">
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="Helvetica, sans-serif">Helvetica</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="Verdana, sans-serif">Verdana</option>
                          </select>
                        </div>
                        <div class="toolbar-group">
                          <label class="checkbox-label">
                            <input type="checkbox" id="label-snap-grid" checked onchange="onLayoutToolbarChange()">
                            <span>Snap</span>
                          </label>
                        </div>
                        <div class="toolbar-group toolbar-actions">
                          <button type="button" class="btn btn-ghost btn-sm" onclick="resetLabelLayout()" title="Reset to default layout">
                            <i data-lucide="rotate-ccw"></i> Reset
                          </button>
                          <button type="button" class="btn btn-primary btn-sm" onclick="saveLabelLayoutSettings()">
                            <i data-lucide="save"></i> Save Layout
                          </button>
                        </div>
                      </div>

                      <!-- 3-Panel Layout -->
                      <div class="label-editor-layout">
                        <!-- Left: Element List -->
                        <div class="label-element-list" id="label-element-list">
                          <div class="element-list-header">Elements</div>
                          <div class="element-list-items" id="label-element-items">
                            <!-- Populated by JS -->
                          </div>
                          <div class="element-list-actions">
                            <button type="button" class="btn btn-ghost btn-sm" onclick="addCustomTextField()" title="Add custom text">
                              <i data-lucide="type"></i> Add Text
                            </button>
                            <button type="button" class="btn btn-ghost btn-sm" onclick="document.getElementById('label-logo-input').click()" title="Add logo image">
                              <i data-lucide="image"></i> Add Logo
                            </button>
                            <input type="file" id="label-logo-input" accept="image/*" style="display:none" onchange="uploadLabelLogo(event)">
                          </div>
                        </div>

                        <!-- Center: Preview Canvas -->
                        <div class="label-preview-area">
                          <div class="label-preview-frame" id="label-preview-frame">
                            <div id="label-preview-canvas" class="label-preview-canvas">
                              <!-- Elements rendered by JS with position:absolute -->
                            </div>
                          </div>
                          <p class="form-hint label-size-hint" id="label-size-hint">384 x 204 px (96 DPI)</p>
                        </div>

                        <!-- Right: Properties Panel -->
                        <div class="label-props-panel" id="label-props-panel">
                          <div class="props-header">Properties</div>
                          <div class="props-content" id="label-props-content">
                            <div class="props-placeholder"><i data-lucide="mouse-pointer"></i> Click an element in the preview to edit its properties</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border);">

                    <!-- Device QR Codes Table -->
                    <div class="qr-codes-header">
                      <span id="qr-codes-count">0 devices</span>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-outline btn-sm" onclick="updateAllQRCodeUrls()" title="Fix QR codes after redeploying">
                          <i data-lucide="refresh-cw"></i> Fix QR URLs
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="generateAllQRCodes()">
                          <i data-lucide="grid-3x3"></i> Generate All
                        </button>
                        <button type="button" class="btn btn-primary" onclick="printAllLabels()">
                          <i data-lucide="printer"></i> Print All Labels
                        </button>
                      </div>
                    </div>

                    <!-- Search and Filter -->
                    <div style="margin-bottom: 16px;">
                      <div class="search-input-wrapper">
                        <i data-lucide="search"></i>
                        <input type="text" id="qr-codes-search" placeholder="Search by name, machine ID, location, serial..." oninput="filterQRCodes()">
                      </div>
                    </div>

                    <div class="qr-codes-table-container">
                      <table class="qr-codes-table">
                        <thead>
                          <tr>
                            <th>Device Name</th>
                            <th>Machine ID</th>
                            <th>Location</th>
                            <th>Serial Number</th>
                            <th>Type</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody id="qr-codes-table-body">
                          <tr><td colspan="6" class="empty-message">Loading devices...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- Technicians Management Section -->
                <div class="settings-panel" id="settings-panel-technicians">
                  <div class="settings-section technicians-section">
                    <h2 class="section-title"><i data-lucide="wrench"></i> Technicians</h2>
                    <p class="section-desc">Manage technicians who can be assigned to alerts</p>

              <div class="tech-header">
                <div class="current-tech-info">
                  <span>Your Name: </span>
                  <strong id="current-tech-display"></strong>
                  <button type="button" class="btn btn-ghost btn-sm" onclick="setCurrentTechName()">
                    <i data-lucide="edit-2"></i>
                  </button>
                </div>
                <button type="button" class="btn btn-primary" onclick="showAddTechModal()">
                  <i data-lucide="user-plus"></i> Add Technician
                </button>
              </div>

              <div id="technicians-list" class="technicians-list">
                <div class="empty-state">
                  <i data-lucide="users"></i>
                  <p>No technicians added yet</p>
                </div>
              </div>
                  </div>
                </div>

                <!-- Application Settings Section -->
                <div class="settings-panel" id="settings-panel-app-settings">
                  <div class="settings-section">
                    <h2 class="section-title"><i data-lucide="sliders-horizontal"></i> Application Settings</h2>
                    <p class="section-desc">Configure general application settings</p>

                    <div class="settings-form">
                      <div class="form-group">
                        <label for="setting-app-title">App Title</label>
                        <input type="text" id="setting-app-title" placeholder="Smart School Monitor">
                      </div>

                      <div class="form-group">
                        <label for="setting-app-subtitle">App Subtitle</label>
                        <input type="text" id="setting-app-subtitle" placeholder="SNMP Network Monitoring System">
                      </div>

                      <div class="form-group">
                        <label for="setting-gateway-url">SNMP Gateway URL</label>
                        <input type="url" id="setting-gateway-url" placeholder="http://localhost:5017">
                      </div>

                      <div class="form-row">
                        <div class="form-group">
                          <label for="setting-snmp-community">SNMP Community</label>
                          <input type="text" id="setting-snmp-community" placeholder="public">
                        </div>
                        <div class="form-group">
                          <label for="setting-snmp-port">SNMP Port</label>
                          <input type="number" id="setting-snmp-port" placeholder="161" min="1" max="65535">
                        </div>
                      </div>

                      <!-- Alert Behavior Settings -->
                      <div class="settings-subsection">
                        <h4><i data-lucide="bell"></i> Alert Behavior</h4>

                        <label class="toggle-option">
                          <input type="checkbox" id="setting-auto-zoom-alerts" checked onchange="saveAutoZoomSetting(this.checked)">
                          <span class="toggle-slider"></span>
                          <div class="toggle-text">
                            <strong>Auto-Zoom on Alerts</strong>
                            <small>Automatically zoom and pan to the device location when an alert is received (SNMP trap or QR code scan)</small>
                          </div>
                        </label>

                        <label class="toggle-option">
                          <input type="checkbox" id="setting-alert-sound" checked onchange="saveAlertSoundSetting(this.checked)">
                          <span class="toggle-slider"></span>
                          <div class="toggle-text">
                            <strong>Alert Sound</strong>
                            <small>Play a sound when new alerts are received</small>
                          </div>
                        </label>
                      </div>

                      <!-- After-Hours Settings -->
                      <div class="settings-subsection">
                        <h4><i data-lucide="clock"></i> After-Hours Settings (QR Code Requests)</h4>
                        <p class="section-desc" style="margin-bottom: 16px;">Configure working hours for QR code service requests. Requests outside these hours will show an after-hours message.</p>

                        <label class="toggle-option">
                          <input type="checkbox" id="setting-after-hours-enabled" checked onchange="saveAfterHoursSettings()">
                          <span class="toggle-slider"></span>
                          <div class="toggle-text">
                            <strong>Enable After-Hours Message</strong>
                            <small>Show special message for requests submitted outside working hours</small>
                          </div>
                        </label>

                        <div class="form-row" style="margin-top: 16px;">
                          <div class="form-group">
                            <label for="setting-work-start">Work Day Starts</label>
                            <input type="time" id="setting-work-start" value="06:30" onchange="saveAfterHoursSettings()">
                          </div>
                          <div class="form-group">
                            <label for="setting-work-end">Work Day Ends</label>
                            <input type="time" id="setting-work-end" value="16:00" onchange="saveAfterHoursSettings()">
                          </div>
                        </div>

                        <div class="form-group">
                          <label>Working Days</label>
                          <div class="checkbox-group">
                            <label class="checkbox-option">
                              <input type="checkbox" id="setting-workday-mon" checked onchange="saveAfterHoursSettings()">
                              <span>Mon</span>
                            </label>
                            <label class="checkbox-option">
                              <input type="checkbox" id="setting-workday-tue" checked onchange="saveAfterHoursSettings()">
                              <span>Tue</span>
                            </label>
                            <label class="checkbox-option">
                              <input type="checkbox" id="setting-workday-wed" checked onchange="saveAfterHoursSettings()">
                              <span>Wed</span>
                            </label>
                            <label class="checkbox-option">
                              <input type="checkbox" id="setting-workday-thu" checked onchange="saveAfterHoursSettings()">
                              <span>Thu</span>
                            </label>
                            <label class="checkbox-option">
                              <input type="checkbox" id="setting-workday-fri" checked onchange="saveAfterHoursSettings()">
                              <span>Fri</span>
                            </label>
                            <label class="checkbox-option">
                              <input type="checkbox" id="setting-workday-sat" onchange="saveAfterHoursSettings()">
                              <span>Sat</span>
                            </label>
                            <label class="checkbox-option">
                              <input type="checkbox" id="setting-workday-sun" onchange="saveAfterHoursSettings()">
                              <span>Sun</span>
                            </label>
                          </div>
                        </div>

                        <div class="form-group">
                          <label for="setting-urgent-email">Urgent Contact Email</label>
                          <input type="email" id="setting-urgent-email" value="itservicedesk@palmbeachschools.org" placeholder="urgent@example.com" onchange="saveAfterHoursSettings()">
                        </div>

                        <div class="form-group">
                          <label for="setting-urgent-phone">Urgent Contact Phone</label>
                          <input type="tel" id="setting-urgent-phone" value="(561) 242-6100" placeholder="(555) 123-4567" onchange="saveAfterHoursSettings()">
                        </div>

                        <div class="form-group">
                          <label for="setting-after-hours-message">After-Hours Message</label>
                          <textarea id="setting-after-hours-message" rows="3" placeholder="Custom message for after-hours requests..." onchange="saveAfterHoursSettings()">Your request has been submitted and will be addressed first thing during the next working hours.</textarea>
                        </div>
                      </div>

                      <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="saveAppSettings()">
                          <i data-lucide="save"></i> Save Settings
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Email Templates Section -->
                <div class="settings-panel" id="settings-panel-email-templates">
                  <div class="settings-section">
                    <h2 class="section-title"><i data-lucide="file-text"></i> Email Templates</h2>
                    <p class="section-desc">Customize the HTML emails sent to employees when they submit service requests</p>

                    <div class="template-list" id="email-templates-list">
                      <!-- Templates loaded dynamically -->
                    </div>

                    <button type="button" class="btn btn-primary" onclick="showEmailTemplateEditor()">
                      <i data-lucide="plus"></i> Add New Template
                    </button>
                  </div>
                </div>

                <!-- Data Management Section -->
                <div class="settings-panel" id="settings-panel-data-management">
                  <div class="settings-section">
                    <h2 class="section-title"><i data-lucide="database"></i> Data Management</h2>
                    <p class="section-desc">Export, import, and manage data across all system sheets.</p>

                    <!-- Backup Actions -->
                    <div class="backup-actions-card">
                      <div class="backup-header">
                        <div class="backup-icon">
                          <i data-lucide="hard-drive-download"></i>
                        </div>
                        <div class="backup-info">
                          <h3>Full System Backup</h3>
                          <p>Download all data from all sheets as a single JSON file</p>
                        </div>
                      </div>
                      <div class="backup-buttons">
                        <button type="button" class="btn btn-primary btn-lg" onclick="createFullBackup()">
                          <i data-lucide="download"></i> Create Backup
                        </button>
                        <button type="button" class="btn btn-outline" onclick="loadSheetStats()">
                          <i data-lucide="refresh-cw"></i> Refresh Stats
                        </button>
                      </div>
                      <div class="backup-last-info" id="backup-last-info">
                        <i data-lucide="clock"></i> <span id="last-backup-time">No backup created this session</span>
                      </div>
                    </div>

                    <!-- Blueprint Cloud Migration -->
                    <div class="backup-actions-card" style="margin-top: 1.5rem;">
                      <div class="backup-header">
                        <div class="backup-icon" style="background: linear-gradient(135deg, #3b82f6, #6366f1);">
                          <i data-lucide="cloud-upload"></i>
                        </div>
                        <div class="backup-info">
                          <h3>Migrate Maps to Cloud</h3>
                          <p>Upload locally-stored floor plan images to Google Drive so they're accessible from any device (phone, tablet, etc.)</p>
                        </div>
                      </div>
                      <div class="backup-buttons">
                        <button type="button" class="btn btn-primary btn-lg" onclick="migrateLocalBlueprintsToDrive()">
                          <i data-lucide="cloud-upload"></i> Migrate Maps to Cloud
                        </button>
                      </div>
                      <div class="backup-last-info">
                        <i data-lucide="info"></i> <span>Run this from the computer where you originally uploaded the maps</span>
                      </div>
                    </div>

                    <!-- Compact Database -->
                    <div class="backup-actions-card" style="margin-top: 1.5rem;">
                      <div class="backup-header">
                        <div class="backup-icon" style="background: linear-gradient(135deg, #f59e0b, #ef4444);">
                          <i data-lucide="shrink"></i>
                        </div>
                        <div class="backup-info">
                          <h3>Compact Database</h3>
                          <p>Remove empty rows and columns from all sheets to reclaim cell quota. Google Sheets has a 10 million cell limit across all sheets.</p>
                        </div>
                      </div>
                      <div class="backup-buttons">
                        <button type="button" class="btn btn-primary btn-lg" onclick="compactDatabase()">
                          <i data-lucide="shrink"></i> Compact Database
                        </button>
                        <button type="button" class="btn btn-outline" onclick="loadSheetStats()">
                          <i data-lucide="refresh-cw"></i> Refresh Stats
                        </button>
                      </div>
                      <div class="backup-last-info" id="compact-cell-info">
                        <i data-lucide="info"></i> <span id="cell-count-info">Cell usage will appear after stats load</span>
                      </div>
                    </div>

                    <!-- Google Sheets Table -->
                    <div class="sheets-table-section">
                      <h3 class="subsection-title"><i data-lucide="table"></i> Google Sheets Overview</h3>
                      <p class="subsection-desc">All sheets used by the application. Click on a sheet name to open it in Google Sheets.</p>
                      <div class="sheets-table-wrapper">
                        <table class="sheets-table" id="sheets-overview-table">
                          <thead>
                            <tr>
                              <th><i data-lucide="file-spreadsheet"></i> Sheet Name</th>
                              <th><i data-lucide="tag"></i> Key</th>
                              <th><i data-lucide="hash"></i> Records</th>
                              <th><i data-lucide="grid-3x3"></i> Cells</th>
                              <th><i data-lucide="info"></i> Description</th>
                              <th><i data-lucide="settings"></i> Actions</th>
                            </tr>
                          </thead>
                          <tbody id="sheets-table-body">
                            <tr><td colspan="6" class="text-center text-muted">Loading sheets...</td></tr>
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <!-- SNMP Traps Table -->
                    <div class="sheets-table-section" style="margin-top: 2rem;">
                      <h3 class="subsection-title"><i data-lucide="bell"></i> SNMP Traps Log</h3>
                      <p class="subsection-desc">Recent SNMP traps received from copiers. Data is stored in Google Sheets.</p>
                      <div class="traps-table-actions" style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button type="button" class="btn btn-primary btn-sm" onclick="loadSnmpTrapsTable()">
                          <i data-lucide="refresh-cw"></i> Refresh
                        </button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="openSnmpTrapsSheet()">
                          <i data-lucide="external-link"></i> Open in Google Sheets
                        </button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="exportSnmpTrapsCSV()">
                          <i data-lucide="download"></i> Export CSV
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" onclick="reprocessTrapsFromUI()" title="Fix traps showing 'Device Alert'">
                          <i data-lucide="wand-2"></i> Fix Alert Messages
                        </button>
                        <span id="snmp-traps-count" class="badge badge-info" style="align-self: center; margin-left: auto;">0 traps</span>
                      </div>
                      <div class="sheets-table-wrapper" style="max-height: 400px; overflow-y: auto;">
                        <table class="sheets-table" id="snmp-traps-table">
                          <thead>
                            <tr>
                              <th style="width: 60px;"><i data-lucide="alert-circle"></i> Severity</th>
                              <th><i data-lucide="server"></i> Source IP</th>
                              <th><i data-lucide="message-square"></i> Message</th>
                              <th><i data-lucide="clock"></i> Received</th>
                              <th style="width: 80px;"><i data-lucide="check-circle"></i> Status</th>
                              <th style="width: 40px;"></th>
                            </tr>
                          </thead>
                          <tbody id="snmp-traps-table-body">
                            <tr><td colspan="6" class="text-center text-muted">Click Refresh to load traps...</td></tr>
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <!-- Legacy Grid (hidden by default, for export cards) -->
                    <div id="data-mgmt-grid" class="data-mgmt-grid" style="display: none;">
                      <p class="text-muted">Loading sheet stats...</p>
                    </div>
                  </div>
                </div>

                <!-- AI Intelligence Section -->
                <div class="settings-panel" id="settings-panel-ai-intelligence">
                  <div class="settings-section">
                    <h2 class="section-title"><i data-lucide="brain"></i> AI Intelligence</h2>
                    <p class="section-desc">View and improve the AI learning database for OCR serial number recognition and pattern matching.</p>

                    <!-- OCR Learning Stats -->
                    <div class="ai-stats-card">
                      <div class="ai-stats-header">
                        <div class="ai-stats-icon">
                          <i data-lucide="scan-line"></i>
                        </div>
                        <div class="ai-stats-info">
                          <h3>OCR Recognition Patterns</h3>
                          <p>Serial number patterns the system uses for extraction</p>
                        </div>
                      </div>
                      <div class="ai-stats-grid">
                        <div class="ai-stat-item">
                          <span class="ai-stat-value" id="ai-stat-patterns">12</span>
                          <span class="ai-stat-label">Active Patterns</span>
                        </div>
                        <div class="ai-stat-item">
                          <span class="ai-stat-value" id="ai-stat-corrections">0</span>
                          <span class="ai-stat-label">User Corrections</span>
                        </div>
                        <div class="ai-stat-item">
                          <span class="ai-stat-value" id="ai-stat-accuracy">--</span>
                          <span class="ai-stat-label">Accuracy Rate</span>
                        </div>
                      </div>
                    </div>

                    <!-- Pattern Database -->
                    <div class="ai-section-card">
                      <h3 class="subsection-title"><i data-lucide="regex"></i> Serial Number Patterns</h3>
                      <p class="subsection-desc">These patterns are used to extract serial numbers from scanned labels.</p>

                      <div class="ai-patterns-list" id="ai-patterns-list">
                        <!-- Palm Beach County -->
                        <div class="ai-pattern-item">
                          <div class="ai-pattern-info">
                            <span class="ai-pattern-name">Palm Beach County Asset Tag</span>
                            <code class="ai-pattern-regex">/^[0-9][A-Z]{1,2}[0-9A-Z]{4,5}$/</code>
                          </div>
                          <div class="ai-pattern-meta">
                            <span class="ai-pattern-example">Example: 5RS3P94</span>
                            <span class="ai-pattern-priority priority-high">High Priority</span>
                          </div>
                        </div>
                        <!-- Dell -->
                        <div class="ai-pattern-item">
                          <div class="ai-pattern-info">
                            <span class="ai-pattern-name">Dell Service Tag</span>
                            <code class="ai-pattern-regex">/^[A-Z0-9]{7}$/</code>
                          </div>
                          <div class="ai-pattern-meta">
                            <span class="ai-pattern-example">Example: 24TFN64</span>
                            <span class="ai-pattern-priority priority-high">High Priority</span>
                          </div>
                        </div>
                        <!-- HP -->
                        <div class="ai-pattern-item">
                          <div class="ai-pattern-info">
                            <span class="ai-pattern-name">HP Serial Number</span>
                            <code class="ai-pattern-regex">/^[2-9][A-Z]{2}\d{7}$/</code>
                          </div>
                          <div class="ai-pattern-meta">
                            <span class="ai-pattern-example">Example: 5CG1234567</span>
                            <span class="ai-pattern-priority priority-medium">Medium Priority</span>
                          </div>
                        </div>
                        <!-- Lenovo -->
                        <div class="ai-pattern-item">
                          <div class="ai-pattern-info">
                            <span class="ai-pattern-name">Lenovo Serial</span>
                            <code class="ai-pattern-regex">/^[A-Z]{2}\d[A-Z0-9]{4,7}$/</code>
                          </div>
                          <div class="ai-pattern-meta">
                            <span class="ai-pattern-example">Example: PF0ABC123</span>
                            <span class="ai-pattern-priority priority-medium">Medium Priority</span>
                          </div>
                        </div>
                        <!-- Apple -->
                        <div class="ai-pattern-item">
                          <div class="ai-pattern-info">
                            <span class="ai-pattern-name">Apple Serial</span>
                            <code class="ai-pattern-regex">/^[A-Z0-9]{12}$/</code>
                          </div>
                          <div class="ai-pattern-meta">
                            <span class="ai-pattern-example">Example: C02X12345678</span>
                            <span class="ai-pattern-priority priority-medium">Medium Priority</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- OCR Corrections Database -->
                    <div class="ai-section-card">
                      <h3 class="subsection-title"><i data-lucide="spell-check-2"></i> OCR Corrections Database</h3>
                      <p class="subsection-desc">When OCR makes mistakes, add corrections here to improve future recognition.</p>

                      <!-- Add Correction Form -->
                      <div class="ai-correction-form">
                        <div class="form-row">
                          <div class="form-group">
                            <label>OCR Detected (Wrong)</label>
                            <input type="text" id="ai-ocr-wrong" placeholder="e.g., S5RS3P94G9" class="form-control">
                          </div>
                          <div class="form-group">
                            <label>Correct Value</label>
                            <input type="text" id="ai-ocr-correct" placeholder="e.g., 5RS3P94" class="form-control">
                          </div>
                          <div class="form-group">
                            <label>Pattern Type</label>
                            <select id="ai-ocr-type" class="form-control">
                              <option value="pbc">Palm Beach County</option>
                              <option value="dell">Dell</option>
                              <option value="hp">HP</option>
                              <option value="lenovo">Lenovo</option>
                              <option value="apple">Apple</option>
                              <option value="other">Other</option>
                            </select>
                          </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="addAiCorrection()">
                          <i data-lucide="plus"></i> Add Correction
                        </button>
                      </div>

                      <!-- Corrections List -->
                      <div class="ai-corrections-list" id="ai-corrections-list">
                        <div class="empty-state small">
                          <i data-lucide="check-circle"></i>
                          <p>No corrections added yet</p>
                        </div>
                      </div>
                    </div>

                    <!-- Common OCR Mistakes -->
                    <div class="ai-section-card">
                      <h3 class="subsection-title"><i data-lucide="alert-circle"></i> Common OCR Mistakes</h3>
                      <p class="subsection-desc">Character substitutions the system automatically corrects.</p>

                      <div class="ai-mistakes-grid">
                        <div class="ai-mistake-item">
                          <span class="mistake-from">5</span>
                          <i data-lucide="arrow-right"></i>
                          <span class="mistake-to">S</span>
                          <span class="mistake-desc">Number 5 misread as letter S</span>
                        </div>
                        <div class="ai-mistake-item">
                          <span class="mistake-from">0</span>
                          <i data-lucide="arrow-right"></i>
                          <span class="mistake-to">O</span>
                          <span class="mistake-desc">Number 0 misread as letter O</span>
                        </div>
                        <div class="ai-mistake-item">
                          <span class="mistake-from">1</span>
                          <i data-lucide="arrow-right"></i>
                          <span class="mistake-to">l / I</span>
                          <span class="mistake-desc">Number 1 misread as l or I</span>
                        </div>
                        <div class="ai-mistake-item">
                          <span class="mistake-from">8</span>
                          <i data-lucide="arrow-right"></i>
                          <span class="mistake-to">B</span>
                          <span class="mistake-desc">Number 8 misread as letter B</span>
                        </div>
                        <div class="ai-mistake-item">
                          <span class="mistake-from">6</span>
                          <i data-lucide="arrow-right"></i>
                          <span class="mistake-to">G</span>
                          <span class="mistake-desc">Number 6 misread as letter G</span>
                        </div>
                        <div class="ai-mistake-item">
                          <span class="mistake-from">2</span>
                          <i data-lucide="arrow-right"></i>
                          <span class="mistake-to">Z</span>
                          <span class="mistake-desc">Number 2 misread as letter Z</span>
                        </div>
                      </div>
                    </div>

                    <!-- AI Actions -->
                    <div class="ai-section-card">
                      <h3 class="subsection-title"><i data-lucide="settings-2"></i> AI Actions</h3>
                      <div class="ai-actions-buttons">
                        <button type="button" class="btn btn-outline" onclick="exportAiDatabase()">
                          <i data-lucide="download"></i> Export Learning Data
                        </button>
                        <button type="button" class="btn btn-outline" onclick="importAiDatabase()">
                          <i data-lucide="upload"></i> Import Learning Data
                        </button>
                        <button type="button" class="btn btn-outline" onclick="resetAiDatabase()">
                          <i data-lucide="refresh-cw"></i> Reset to Defaults
                        </button>
                      </div>
                    </div>

                  </div>
                </div>

                <!-- Danger Zone Section -->
                <div class="settings-panel" id="settings-panel-danger-zone">
                  <div class="settings-section danger-zone">
                    <h2 class="section-title"><i data-lucide="alert-triangle"></i> Danger Zone</h2>
                    <p class="section-desc">Irreversible and destructive actions</p>

              <div class="danger-actions">
                <div class="danger-item">
                  <div>
                    <h4>Clear All Devices</h4>
                    <p>Remove all devices from the system</p>
                  </div>
                  <button type="button" class="btn btn-danger" onclick="confirmClearDevices()">
                    <i data-lucide="trash-2"></i> Clear Devices
                  </button>
                </div>
                <div class="danger-item">
                  <div>
                    <h4>Clear All Traps</h4>
                    <p>Delete all SNMP trap history</p>
                  </div>
                  <button type="button" class="btn btn-danger" onclick="confirmClearTraps()">
                    <i data-lucide="trash-2"></i> Clear Traps
                  </button>
                </div>
                      <div class="danger-item">
                        <div>
                          <h4>Export All Data</h4>
                          <p>Download all data as JSON</p>
                        </div>
                        <button type="button" class="btn btn-outline" onclick="exportData()">
                          <i data-lucide="download"></i> Export
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Debug Console Section -->
                <div class="settings-panel" id="settings-panel-debug-console">
                  <div class="settings-section">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                      <div>
                        <h2 class="section-title"><i data-lucide="bug"></i> Debug Console</h2>
                        <p class="section-desc">Test every function in the system. Green = pass, Red = fail.</p>
                      </div>
                      <div style="display:flex; gap:8px;">
                        <button type="button" class="btn btn-primary" onclick="debugRunAllTests()">
                          <i data-lucide="play"></i> Run All Tests
                        </button>
                        <button type="button" class="btn btn-outline" onclick="debugClearResults()">
                          <i data-lucide="trash-2"></i> Clear
                        </button>
                      </div>
                    </div>

                    <!-- Progress bar -->
                    <div id="debug-progress-wrap" style="display:none; margin-bottom:20px;">
                      <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                        <span id="debug-progress-label" style="font-size:13px; color:var(--text-muted);">Running tests...</span>
                        <span id="debug-progress-count" style="font-size:13px; font-weight:600;">0/0</span>
                      </div>
                      <div style="height:8px; background:var(--bg-tertiary); border-radius:4px; overflow:hidden;">
                        <div id="debug-progress-bar" style="height:100%; width:0%; background:var(--primary); border-radius:4px; transition:width 0.3s;"></div>
                      </div>
                    </div>

                    <!-- Summary -->
                    <div id="debug-summary" style="display:none; margin-bottom:20px; padding:16px; border-radius:12px; background:var(--bg-secondary); border:1px solid var(--border-color);">
                      <div style="display:flex; gap:24px; flex-wrap:wrap;">
                        <div><span style="font-size:24px; font-weight:700;" id="debug-total">0</span><br><span style="font-size:12px; color:var(--text-muted);">Total</span></div>
                        <div><span style="font-size:24px; font-weight:700; color:var(--success);" id="debug-passed">0</span><br><span style="font-size:12px; color:var(--text-muted);">Passed</span></div>
                        <div><span style="font-size:24px; font-weight:700; color:var(--danger);" id="debug-failed">0</span><br><span style="font-size:12px; color:var(--text-muted);">Failed</span></div>
                        <div><span style="font-size:24px; font-weight:700; color:var(--warning);" id="debug-skipped">0</span><br><span style="font-size:12px; color:var(--text-muted);">Skipped</span></div>
                        <div><span style="font-size:24px; font-weight:700; color:var(--text-muted);" id="debug-time">0s</span><br><span style="font-size:12px; color:var(--text-muted);">Duration</span></div>
                      </div>
                    </div>

                    <!-- Test Categories -->
                    <div id="debug-test-categories" style="display:flex; flex-direction:column; gap:12px;"></div>
                  </div>
                </div>

              </div><!-- End settings-content -->
            </div><!-- End settings-layout -->
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Rename Blueprint Modal -->
  <div id="rename-blueprint-modal" class="modal">
    <div class="modal-backdrop" onclick="closeRenameBlueprintModal()"></div>
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h3>Rename Blueprint</h3>
        <button type="button" class="modal-close" onclick="closeRenameBlueprintModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-muted); margin-bottom: 16px;">Give this blueprint a custom name like "Media Center", "Main Office", etc.</p>
        <div class="form-group">
          <label for="blueprint-new-name">Blueprint Name</label>
          <input type="text" id="blueprint-new-name" placeholder="Enter blueprint name">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeRenameBlueprintModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveBlueprintName()">Save</button>
      </div>
    </div>
  </div>

  <!-- Device Detail Modal -->
  <div id="device-modal" class="modal">
    <div class="modal-backdrop" onclick="closeDeviceModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-device-name">Device Name</h3>
        <button type="button" class="modal-close" onclick="closeDeviceModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body" id="modal-device-body">
        <!-- Filled dynamically -->
      </div>
      <div class="modal-footer" id="modal-device-footer">
        <!-- Filled dynamically -->
      </div>
    </div>
  </div>

  <!-- Device Picker Modal (shown when placing on blueprint) -->
  <div id="device-picker-modal" class="modal">
    <div class="modal-backdrop" onclick="closeDevicePicker()"></div>
    <div class="modal-content" style="max-width:520px;">
      <div class="modal-header">
        <h3><i data-lucide="map-pin"></i> Place Device on Map</h3>
        <button type="button" class="modal-close" onclick="closeDevicePicker()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body" style="padding:0;">
        <div class="device-picker-search" style="padding:12px 16px; border-bottom:1px solid var(--border-color, #e2e8f0);">
          <input type="text" id="device-picker-search" placeholder="Search devices by name, IP, or location..." style="width:100%; padding:8px 12px; border:1px solid var(--border-color, #e2e8f0); border-radius:8px; font-size:14px;" oninput="filterDevicePicker(this.value)" />
        </div>
        <div id="device-picker-list" class="device-picker-list" style="max-height:400px; overflow-y:auto; padding:8px;">
          <!-- Populated dynamically -->
        </div>
      </div>
      <div class="modal-footer" style="justify-content:space-between;">
        <button type="button" class="btn btn-ghost" onclick="closeDevicePicker()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="pickerCreateNewDevice()">
          <i data-lucide="plus"></i> Create New Device
        </button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Device Modal -->
  <div id="add-device-modal" class="modal">
    <div class="modal-backdrop" onclick="closeAddDeviceModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="add-device-title">Add New Device</h3>
        <button type="button" class="modal-close" onclick="closeAddDeviceModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <form id="device-form" onsubmit="saveDeviceForm(event)">
        <div class="modal-body">
          <input type="hidden" id="device-id">
          <input type="hidden" id="device-x">
          <input type="hidden" id="device-y">
          <input type="hidden" id="device-blueprint-id">

          <div class="form-group">
            <label for="device-name">Device Name *</label>
            <input type="text" id="device-name" required placeholder="e.g., Library Printer">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="device-ip">IP Address *</label>
              <input type="text" id="device-ip" required placeholder="192.168.1.100" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$">
            </div>
            <div class="form-group">
              <label for="device-type">Type</label>
              <select id="device-type">
                <option value="">Select type...</option>
                <!-- Options will be populated dynamically from Device Types settings -->
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="device-model">Model</label>
              <input type="text" id="device-model" placeholder="e.g., HP LaserJet Pro">
            </div>
            <div class="form-group">
              <label for="device-location">Location</label>
              <input type="text" id="device-location" placeholder="e.g., Room 201">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="device-machine-id">Machine ID</label>
              <input type="text" id="device-machine-id" placeholder="e.g., MFP-001">
            </div>
            <div class="form-group">
              <label for="device-serial">Serial Number</label>
              <input type="text" id="device-serial" placeholder="e.g., ABC123456789">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" onclick="closeAddDeviceModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i data-lucide="save"></i> Save Device
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Teacher Modal -->
  <div id="add-teacher-modal" class="modal">
    <div class="modal-backdrop" onclick="closeAddTeacherModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="add-teacher-title">Add New Teacher</h3>
        <button type="button" class="modal-close" onclick="closeAddTeacherModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <form id="teacher-form" onsubmit="saveTeacherForm(event)">
        <div class="modal-body">
          <input type="hidden" id="teacher-id">

          <div class="form-group">
            <label for="teacher-emp-id">Employee ID *</label>
            <input type="text" id="teacher-emp-id" required placeholder="e.g., EMP001">
          </div>

          <div class="form-group">
            <label for="teacher-name">Full Name *</label>
            <input type="text" id="teacher-name" required placeholder="e.g., John Smith">
          </div>

          <div class="form-group">
            <label for="teacher-email">Email *</label>
            <input type="email" id="teacher-email" required placeholder="e.g., john.smith@school.edu">
          </div>

          <div class="form-group">
            <label for="teacher-room">Room Number</label>
            <input type="text" id="teacher-room" placeholder="e.g., Room 201">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" onclick="closeAddTeacherModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i data-lucide="save"></i> Save Teacher
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- CSV Import Preview Modal -->
  <div id="csv-preview-modal" class="modal">
    <div class="modal-backdrop" onclick="closeCSVPreviewModal()"></div>
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Import Teachers from CSV</h3>
        <button type="button" class="modal-close" onclick="closeCSVPreviewModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body">
        <p class="csv-info">Review the data before importing. The CSV should have columns: <strong>empId</strong> (or "emp id"), <strong>name</strong>, <strong>email</strong>, <strong>roomNumber</strong> (or "room number")</p>
        <div class="csv-preview-stats">
          <span id="csv-rows-count">0 rows found</span>
        </div>
        <div class="csv-preview-table-container">
          <table class="csv-preview-table">
            <thead id="csv-preview-head"></thead>
            <tbody id="csv-preview-body"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeCSVPreviewModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="confirmCSVImport()">
          <i data-lucide="upload"></i> Import Teachers
        </button>
      </div>
    </div>
  </div>

  <!-- Manage Device Types Modal (List all types with their maps) -->
  <div id="manage-device-types-modal" class="modal">
    <div class="modal-backdrop" onclick="closeManageDeviceTypesModal()"></div>
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3><i data-lucide="layers"></i> Manage Device Types & Maps</h3>
        <button type="button" class="modal-close" onclick="closeManageDeviceTypesModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body" style="padding: 0;">
        <div style="padding: 12px 16px; border-bottom: 1px solid var(--border-color); background: var(--bg-secondary);">
          <p style="font-size: 13px; color: var(--text-muted); margin: 0;">
            Each device type has its own map. Assign blueprints to device types to organize your devices by category.
          </p>
        </div>
        <div id="device-types-list" style="max-height: 400px; overflow-y: auto;">
          <!-- Populated dynamically -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeManageDeviceTypesModal()">Close</button>
        <button type="button" class="btn btn-primary" onclick="showAddDeviceTypeModal()">
          <i data-lucide="plus"></i> Add Device Type
        </button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Device Type Modal -->
  <div id="device-type-modal" class="modal">
    <div class="modal-backdrop" onclick="closeDeviceTypeModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="device-type-modal-title">Add Device Type</h3>
        <button type="button" class="modal-close" onclick="closeDeviceTypeModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <form id="device-type-form" onsubmit="saveDeviceTypeForm(event)">
        <div class="modal-body">
          <input type="hidden" id="device-type-id">

          <div class="form-group">
            <label for="device-type-name">Type Name *</label>
            <input type="text" id="device-type-name" required placeholder="e.g., Copier, Printer, Projector">
          </div>

          <div class="form-group">
            <label>Icon</label>
            <input type="hidden" id="device-type-icon" value="printer">
            <button type="button" class="icon-picker-btn" onclick="showDeviceTypeIconPicker()">
              <span class="icon-preview" id="device-type-icon-preview">
                <i data-lucide="printer"></i>
              </span>
              <span class="icon-label" id="device-type-icon-label">printer</span>
              <i data-lucide="chevron-down" class="chevron"></i>
            </button>
          </div>

          <div class="form-group">
            <label for="device-type-color">Marker Color (on Map)</label>
            <div class="color-input-wrapper">
              <input type="color" id="device-type-color" value="#3b82f6" oninput="syncDeviceTypeColor(this.value)">
              <input type="text" id="device-type-color-hex" value="#3b82f6" placeholder="#3b82f6" maxlength="7" oninput="syncDeviceTypeColorFromHex(this.value)">
              <div id="device-type-color-preview" style="width:36px; height:36px; min-width:36px; border-radius:6px; background:#3b82f6; border:1px solid var(--border);"></div>
            </div>
            <p class="form-hint" style="font-size:11px; color:var(--text-muted); margin-top:4px;">
              All devices of this type will display with this color on the map.
            </p>
          </div>

          <div class="form-group">
            <label for="device-type-description">Description</label>
            <textarea id="device-type-description" placeholder="Optional description for this device type" rows="2"></textarea>
          </div>

          <div class="form-group">
            <label for="device-type-blueprint">Map/Blueprint for this Device Type</label>
            <select id="device-type-blueprint">
              <option value="">-- Select Map --</option>
              <!-- Populated dynamically -->
            </select>
            <p class="form-hint" style="font-size:11px; color:var(--text-muted); margin-top:4px;">
              Each device type can have its own dedicated map. Devices of this type will be displayed on this map.
            </p>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="device-type-active" checked>
              <span>Active (can be assigned to devices)</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" onclick="closeDeviceTypeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i data-lucide="save"></i> Save Device Type
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Device Type Icon Picker Modal -->
  <div id="device-type-icon-picker-modal" class="modal" style="display:none;">
    <div class="modal-backdrop" onclick="closeDeviceTypeIconPicker()"></div>
    <div class="modal-content icon-picker-modal-content">
      <div class="modal-header">
        <h3><i data-lucide="grid-3x3"></i> Select Device Icon</h3>
        <button type="button" class="modal-close" onclick="closeDeviceTypeIconPicker()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="text" id="device-type-icon-picker-search" placeholder="Search icons..." oninput="filterDeviceTypePickerIcons(this.value)">

        <div class="icon-picker-tabs">
          <button type="button" class="picker-tab active" onclick="switchDeviceTypePickerTab('lucide')">Lucide Icons</button>
          <button type="button" class="picker-tab" onclick="switchDeviceTypePickerTab('custom')">Custom Icons</button>
        </div>

        <div class="icon-picker-grid" id="device-type-icon-picker-grid">
          <!-- Populated dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Issue Button Modal -->
  <div id="issue-button-modal" class="modal">
    <div class="modal-backdrop" onclick="closeIssueButtonModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="issue-button-modal-title">Add Issue Button</h3>
        <button type="button" class="modal-close" onclick="closeIssueButtonModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <form id="issue-button-form" onsubmit="saveIssueButtonForm(event)">
        <div class="modal-body">
          <input type="hidden" id="issue-button-id">

          <div class="form-group">
            <label for="issue-button-device-type">Device Type *</label>
            <select id="issue-button-device-type" required>
              <option value="">Select device type...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="issue-button-label">Button Label *</label>
            <input type="text" id="issue-button-label" required placeholder="e.g., Paper Jam, Needs Toner">
          </div>

          <div class="form-group">
            <label>Icon</label>
            <input type="hidden" id="issue-button-icon" value="alert-circle">
            <button type="button" class="icon-picker-btn" onclick="showIssueButtonIconPicker()">
              <span class="icon-preview" id="issue-button-icon-preview">
                <i data-lucide="alert-circle"></i>
              </span>
              <span class="icon-label" id="issue-button-icon-label">alert-circle</span>
              <i data-lucide="chevron-down" class="chevron"></i>
            </button>
          </div>

          <div class="form-group">
            <label for="issue-button-priority">Default Priority</label>
            <select id="issue-button-priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="critical">Critical</option>
            </select>
          </div>

          <div class="form-group">
            <label for="issue-button-order">Display Order</label>
            <input type="number" id="issue-button-order" value="0" min="0" placeholder="0">
            <small class="form-hint">Lower numbers appear first</small>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="issue-button-active" checked>
              <span>Active (visible on request page)</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" onclick="closeIssueButtonModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i data-lucide="save"></i> Save Issue Button
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Issue Button Icon Picker Modal -->
  <div id="issue-button-icon-picker-modal" class="modal" style="display:none;">
    <div class="modal-backdrop" onclick="closeIssueButtonIconPicker()"></div>
    <div class="modal-content icon-picker-modal-content">
      <div class="modal-header">
        <h3><i data-lucide="grid-3x3"></i> Select Issue Icon</h3>
        <button type="button" class="modal-close" onclick="closeIssueButtonIconPicker()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="text" id="issue-button-icon-picker-search" placeholder="Search icons..." oninput="filterIssueButtonPickerIcons(this.value)">

        <div class="icon-picker-tabs">
          <button type="button" class="picker-tab active" onclick="switchIssueButtonPickerTab('lucide')">Lucide Icons</button>
          <button type="button" class="picker-tab" onclick="switchIssueButtonPickerTab('custom')">Custom Icons</button>
          <button type="button" class="picker-tab" onclick="switchIssueButtonPickerTab('emoji')">Emoji</button>
        </div>

        <div class="icon-picker-grid" id="issue-button-icon-picker-grid">
          <!-- Populated dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Repair Template Editor Modal -->
  <div id="repair-template-editor-modal" class="modal">
    <div class="modal-backdrop" onclick="closeRepairTemplateEditor()"></div>
    <div class="modal-content" style="max-width: 640px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3><i data-lucide="layout-template"></i> New Template</h3>
        <button type="button" class="modal-close" onclick="closeRepairTemplateEditor()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="rt-edit-id">

        <div class="form-group">
          <label for="rt-edit-name">Template Name *</label>
          <input type="text" id="rt-edit-name" placeholder="e.g., Broken MAX Case" required>
        </div>

        <div class="form-group">
          <label for="rt-edit-icon">Icon (Lucide name)</label>
          <input type="text" id="rt-edit-icon" value="file-text" placeholder="e.g., shield-off, monitor-x">
          <small class="form-hint">Use any <a href="https://lucide.dev/icons" target="_blank">Lucide icon</a> name</small>
        </div>

        <div class="form-group">
          <label for="rt-edit-short-desc">Short Description (Summary) *</label>
          <input type="text" id="rt-edit-short-desc" placeholder="e.g., SWAP Chromebook - Broken MAX Case">
          <small class="form-hint">Becomes the ServiceNow incident summary</small>
        </div>

        <div class="form-group">
          <label for="rt-edit-description">Full Description</label>
          <textarea id="rt-edit-description" rows="3" placeholder="Detailed description for ServiceNow..."></textarea>
        </div>

        <hr style="margin:16px 0; border-color:var(--border);">
        <h4 style="margin-bottom:12px; font-size:14px; color:var(--text-secondary);">ServiceNow Fields</h4>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="form-group">
            <label for="rt-edit-channel">Channel</label>
            <select id="rt-edit-channel">
              <option value="self-service">Self-service</option>
              <option value="phone">Phone</option>
              <option value="email">Email</option>
              <option value="walk-in">Walk-in</option>
            </select>
          </div>
          <div class="form-group">
            <label for="rt-edit-category">Category</label>
            <input type="text" id="rt-edit-category" value="Hardware" placeholder="e.g., Hardware">
          </div>
          <div class="form-group">
            <label for="rt-edit-subcategory">Subcategory</label>
            <input type="text" id="rt-edit-subcategory" placeholder="e.g., Chromebook">
          </div>
          <div class="form-group">
            <label for="rt-edit-service-offering">Service Offering</label>
            <input type="text" id="rt-edit-service-offering" value="Other" placeholder="e.g., Other">
          </div>
          <div class="form-group">
            <label for="rt-edit-manufacturer">Manufacturer</label>
            <input type="text" id="rt-edit-manufacturer" placeholder="e.g., Dell">
          </div>
          <div class="form-group">
            <label for="rt-edit-model">Model</label>
            <input type="text" id="rt-edit-model" placeholder="e.g., Chromebook 3120 2-in-1">
          </div>
          <div class="form-group">
            <label for="rt-edit-asset-location">Asset Location</label>
            <input type="text" id="rt-edit-asset-location" placeholder="e.g., 1-153-J Techs Office">
          </div>
          <div class="form-group">
            <label for="rt-edit-impact">Impact</label>
            <select id="rt-edit-impact">
              <option value="1">1 - High</option>
              <option value="2">2 - Medium</option>
              <option value="3">3 - Low</option>
              <option value="4" selected>4 - Planning</option>
            </select>
          </div>
          <div class="form-group">
            <label for="rt-edit-user-type">User Type</label>
            <select id="rt-edit-user-type">
              <option value="Student">Student</option>
              <option value="school_staff">School Staff</option>
              <option value="teacher">Teacher</option>
              <option value="administrator">Administrator</option>
            </select>
          </div>
          <div class="form-group">
            <label for="rt-edit-sort-order">Sort Order</label>
            <input type="number" id="rt-edit-sort-order" value="0" min="0">
            <small class="form-hint">Lower = first in dropdown</small>
          </div>
        </div>

        <hr style="margin:16px 0; border-color:var(--border);">
        <h4 style="margin-bottom:12px; font-size:14px; color:var(--text-secondary);">Form Options</h4>

        <div style="display:flex; gap:24px; flex-wrap:wrap;">
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="rt-edit-requires-serial" checked>
              <span>Requires Serial Number</span>
            </label>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="rt-edit-requires-photo" checked>
              <span>Requires Photo</span>
            </label>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="rt-edit-active" checked>
              <span>Active (visible in dropdown)</span>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeRepairTemplateEditor()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveRepairTemplateFromEditor()">
          <i data-lucide="save"></i> Save Template
        </button>
      </div>
    </div>
  </div>

  <!-- Service Request Detail Modal -->
  <div id="service-request-modal" class="modal">
    <div class="modal-backdrop" onclick="closeServiceRequestModal()"></div>
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 id="service-request-modal-title">Service Request Details</h3>
        <button type="button" class="modal-close" onclick="closeServiceRequestModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="request-detail-grid">
          <div class="request-detail-item">
            <label>Request ID</label>
            <span id="sr-detail-id">-</span>
          </div>
          <div class="request-detail-item">
            <label>Status</label>
            <span id="sr-detail-status">-</span>
          </div>
          <div class="request-detail-item">
            <label>Device</label>
            <span id="sr-detail-device">-</span>
          </div>
          <div class="request-detail-item">
            <label>Location</label>
            <span id="sr-detail-location">-</span>
          </div>
          <div class="request-detail-item">
            <label>Issue</label>
            <span id="sr-detail-issue">-</span>
          </div>
          <div class="request-detail-item">
            <label>Source</label>
            <span id="sr-detail-priority">-</span>
          </div>
          <div class="request-detail-item">
            <label>Submitted By</label>
            <span id="sr-detail-submitter">-</span>
          </div>
          <div class="request-detail-item">
            <label>Submitted At</label>
            <span id="sr-detail-submitted">-</span>
          </div>
          <div class="request-detail-item full-width">
            <label>Notes</label>
            <span id="sr-detail-notes">-</span>
          </div>
        </div>

        <hr class="divider">

        <div class="request-assignment-section">
          <h4>Assignment</h4>
          <div class="form-group">
            <label for="sr-assign-technician">Assign Technician</label>
            <input type="text" id="sr-assign-technician" placeholder="Technician name">
          </div>
          <div class="form-group">
            <label for="sr-resolution-notes">Resolution Notes</label>
            <textarea id="sr-resolution-notes" placeholder="Notes about the resolution..." rows="3"></textarea>
          </div>
        </div>

        <hr class="divider">

        <div class="request-email-history-section">
          <h4><i data-lucide="mail" style="width:16px;height:16px;"></i> Email History</h4>
          <div id="sr-email-history" class="sr-email-history">
            <p class="text-muted" style="font-size:13px;">No emails sent for this device.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeServiceRequestModal()">Close</button>
        <button type="button" class="btn btn-warning" id="sr-btn-assign" onclick="assignServiceRequestFromModal()">
          <i data-lucide="user-plus"></i> Assign
        </button>
        <button type="button" class="btn btn-success" id="sr-btn-complete" onclick="completeServiceRequestFromModal()">
          <i data-lucide="check-circle"></i> Complete
        </button>
      </div>
    </div>
  </div>

  <!-- QR Code Preview Modal -->
  <div id="qr-code-modal" class="modal">
    <div class="modal-backdrop" onclick="closeQRCodeModal()"></div>
    <div class="modal-content" style="max-width: 400px; text-align: center;">
      <div class="modal-header">
        <h3 id="qr-code-modal-title">QR Code</h3>
        <button type="button" class="modal-close" onclick="closeQRCodeModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="qr-code-display" class="qr-code-display">
          <!-- QR Code image will be inserted here -->
        </div>
        <div id="qr-code-info" class="qr-code-info">
          <p><strong>Device:</strong> <span id="qr-device-name">-</span></p>
          <p><strong>Location:</strong> <span id="qr-device-location">-</span></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeQRCodeModal()">Close</button>
        <button type="button" class="btn btn-secondary" onclick="downloadQRCode()">
          <i data-lucide="download"></i> Download
        </button>
        <button type="button" class="btn btn-primary" onclick="printQRLabel()">
          <i data-lucide="printer"></i> Print Label
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Hidden File Inputs -->
  <input type="file" id="blueprint-upload" accept="image/*,.pdf" style="display:none" onchange="handleBlueprintUpload(event)">
  <input type="file" id="csv-upload" accept=".csv" style="display:none" onchange="handleCSVUpload(event)">

  <!-- Email Template Editor Modal -->
  <div id="email-template-modal" class="modal">
    <div class="modal-backdrop" onclick="closeEmailTemplateModal()"></div>
    <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
      <div class="modal-header">
        <h3 id="email-template-modal-title">Edit Email Template</h3>
        <button type="button" class="modal-close" onclick="closeEmailTemplateModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 140px);">
        <input type="hidden" id="email-template-id">

        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label for="email-template-name">Template Name</label>
            <input type="text" id="email-template-name" placeholder="e.g., Service Request Confirmation">
          </div>
          <div class="form-group" style="flex: 0 0 200px;">
            <label for="email-template-type">Template Type</label>
            <select id="email-template-type" onchange="onTemplateTypeChange()">
              <option value="confirmation">Service Request Confirmation</option>
              <option value="assignment">Technician Assignment</option>
              <option value="completion">Request Completed</option>
              <option value="manufacturer">Manufacturer Repair Request</option>
              <option value="custom">Custom</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="email-template-subject">Email Subject</label>
          <input type="text" id="email-template-subject" placeholder="e.g., Service Request Received - {{issueLabel}}">
          <small style="color: var(--text-muted);">Use {{variableName}} for dynamic content</small>
        </div>

        <div class="form-group">
          <label>Available Variables</label>
          <div id="service-request-vars" class="template-variables" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 12px;">
            <code class="variable-tag" onclick="insertVariable('employeeName')" title="Click to insert">{{employeeName}}</code>
            <code class="variable-tag" onclick="insertVariable('issueLabel')" title="Click to insert">{{issueLabel}}</code>
            <code class="variable-tag" onclick="insertVariable('deviceName')" title="Click to insert">{{deviceName}}</code>
            <code class="variable-tag" onclick="insertVariable('location')" title="Click to insert">{{location}}</code>
            <code class="variable-tag" onclick="insertVariable('submittedAt')" title="Click to insert">{{submittedAt}}</code>
            <code class="variable-tag" onclick="insertVariable('requestId')" title="Click to insert">{{requestId}}</code>
            <code class="variable-tag" onclick="insertVariable('afterHoursMessage')" title="Click to insert">{{afterHoursMessage}}</code>
            <code class="variable-tag" onclick="insertVariable('urgentEmail')" title="Click to insert">{{urgentEmail}}</code>
            <code class="variable-tag" onclick="insertVariable('urgentPhone')" title="Click to insert">{{urgentPhone}}</code>
            <code class="variable-tag" onclick="insertVariable('footerMessage')" title="Click to insert">{{footerMessage}}</code>
          </div>
          <div id="manufacturer-vars" class="template-variables" style="display: none; flex-wrap: wrap; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 12px;">
            <code class="variable-tag" onclick="insertVariable('message')" title="Click to insert">{{message}}</code>
            <code class="variable-tag" onclick="insertVariable('deviceName')" title="Click to insert">{{deviceName}}</code>
            <code class="variable-tag" onclick="insertVariable('model')" title="Click to insert">{{model}}</code>
            <code class="variable-tag" onclick="insertVariable('ip')" title="Click to insert">{{ip}}</code>
            <code class="variable-tag" onclick="insertVariable('location')" title="Click to insert">{{location}}</code>
            <code class="variable-tag" onclick="insertVariable('machineId')" title="Click to insert">{{machineId}}</code>
            <code class="variable-tag" onclick="insertVariable('serialNumber')" title="Click to insert">{{serialNumber}}</code>
            <code class="variable-tag" onclick="insertVariable('deviceType')" title="Click to insert">{{deviceType}}</code>
            <code class="variable-tag" onclick="insertVariable('status')" title="Click to insert">{{status}}</code>
            <code class="variable-tag" onclick="insertVariable('statusColor')" title="Click to insert">{{statusColor}}</code>
            <code class="variable-tag" onclick="insertVariable('supplyLevels')" title="Click to insert">{{supplyLevels}}</code>
            <code class="variable-tag" onclick="insertVariable('dateTime')" title="Click to insert">{{dateTime}}</code>
            <code class="variable-tag" onclick="insertVariable('schoolName')" title="Click to insert">{{schoolName}}</code>
          </div>
          <small id="sr-vars-hint" style="color: var(--text-muted);">For after-hours section: wrap content in <code>{{#afterHoursSection}}...{{/afterHoursSection}}</code></small>
          <small id="mfg-vars-hint" style="display: none; color: var(--text-muted);">These variables are auto-populated from device data when sending a manufacturer repair request.</small>
        </div>

        <div class="form-group">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label for="email-template-body">HTML Body</label>
            <div style="display: flex; gap: 8px;">
              <button type="button" class="btn btn-sm btn-outline" onclick="previewEmailTemplate()">
                <i data-lucide="eye"></i> Preview
              </button>
              <button type="button" class="btn btn-sm btn-outline" onclick="resetToDefaultTemplate()">
                <i data-lucide="rotate-ccw"></i> Reset to Default
              </button>
            </div>
          </div>
          <textarea id="email-template-body" rows="20" style="font-family: monospace; font-size: 13px;" placeholder="Enter HTML template..."></textarea>
        </div>

        <div class="form-group">
          <label class="toggle-label">
            <input type="checkbox" id="email-template-active" checked>
            <span class="toggle-switch"></span>
            <span>Template Active</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeEmailTemplateModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveEmailTemplate()">
          <i data-lucide="save"></i> Save Template
        </button>
      </div>
    </div>
  </div>

  <!-- Email Preview Modal -->
  <div id="email-preview-modal" class="modal">
    <div class="modal-backdrop" onclick="closeEmailPreviewModal()"></div>
    <div class="modal-content" style="max-width: 700px; max-height: 90vh;">
      <div class="modal-header">
        <h3>Email Preview</h3>
        <button type="button" class="modal-close" onclick="closeEmailPreviewModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body" style="padding: 0; overflow: hidden;">
        <iframe id="email-preview-frame" style="width: 100%; height: 500px; border: none;"></iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeEmailPreviewModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Device Import Modal -->
  <div id="device-import-modal" class="modal">
    <div class="modal-backdrop" onclick="closeDeviceImportModal()"></div>
    <div class="modal-content" style="max-width:540px;">
      <div class="modal-header">
        <h3><i data-lucide="upload"></i> Import Devices</h3>
        <button type="button" class="modal-close" onclick="closeDeviceImportModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body">
        <p style="color:var(--text-secondary); margin-bottom:14px; font-size:13px;">Upload a CSV file with your device data. Only these columns are needed:</p>
        <div class="device-import-columns">
          <span class="device-import-col">IP Address</span>
          <span class="device-import-col">Model</span>
          <span class="device-import-col">Machine ID</span>
          <span class="device-import-col">Serial Number</span>
          <span class="device-import-col">Location</span>
        </div>
        <p style="color:var(--text-secondary); margin:12px 0 6px; font-size:12px;">Column headers are flexible ‚Äî "IP", "IP Address", "ip_address" all work. You can also include a "Name" column. Any extra columns are ignored.</p>
        <button type="button" class="btn btn-ghost btn-sm" onclick="downloadDeviceTemplate()" style="margin-bottom:14px;">
          <i data-lucide="file-down"></i> Download CSV Template
        </button>
        <div class="form-group">
          <label for="device-import-file">CSV File</label>
          <input type="file" id="device-import-file" accept=".csv" style="padding:8px;" />
        </div>
        <div id="device-import-status" style="display:none; margin-top:12px; padding:10px; border-radius:8px; font-size:13px;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeDeviceImportModal()">Cancel</button>
        <button type="button" class="btn btn-primary" id="device-import-btn" onclick="submitDeviceImport()">
          <i data-lucide="upload"></i> Import Devices
        </button>
      </div>
    </div>
  </div>

  <!-- CSV Import Modal -->
  <div id="csv-import-modal" class="modal">
    <div class="modal-backdrop" onclick="closeCsvImportModal()"></div>
    <div class="modal-content" style="max-width:500px;">
      <div class="modal-header">
        <h3><i data-lucide="upload"></i> Import CSV</h3>
        <button type="button" class="modal-close" onclick="closeCsvImportModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body">
        <p class="text-muted" style="margin-bottom:12px;">Select a CSV file to import into <strong id="csv-import-sheet-label"></strong>. The CSV headers must match the sheet columns exactly. Rows will be appended to existing data.</p>
        <div class="form-group">
          <label for="csv-import-file">CSV File</label>
          <input type="file" id="csv-import-file" accept=".csv" style="padding:8px;" />
        </div>
        <div id="csv-import-status" style="display:none; margin-top:12px; padding:10px; border-radius:8px; font-size:13px;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeCsvImportModal()">Cancel</button>
        <button type="button" class="btn btn-primary" id="csv-import-btn" onclick="submitCsvImport()">
          <i data-lucide="upload"></i> Import
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Floating Action Button -->
  <button type="button" class="mobile-fab" id="mobile-fab" onclick="toggleSidebar()" aria-label="Open menu">
    <i data-lucide="menu"></i>
  </button>

  <!-- Mobile Quick Actions Bar -->
  <div class="mobile-quick-bar" id="mobile-quick-bar">
    <button type="button" class="mqb-btn active" data-tab="blueprint" onclick="switchTab('blueprint')">
      <i data-lucide="map"></i>
      <span>Map</span>
    </button>
    <button type="button" class="mqb-btn" data-tab="dashboard" onclick="switchTab('dashboard')">
      <i data-lucide="layout-dashboard"></i>
      <span>Dashboard</span>
    </button>
    <button type="button" class="mqb-btn" data-tab="overview" onclick="switchTab('overview')">
      <i data-lucide="pie-chart"></i>
      <span>Overview</span>
    </button>
    <button type="button" class="mqb-btn" data-tab="devices" onclick="switchTab('devices')">
      <i data-lucide="printer"></i>
      <span>Devices</span>
    </button>
    <button type="button" class="mqb-btn" onclick="toggleSidebar()">
      <i data-lucide="more-horizontal"></i>
      <span>More</span>
    </button>
  </div>

  <script src="/js/api-shim.js"></script>
<script src="/js/app.js"></script>

  <script>
    // Initialize Lucide icons (with guard in case CDN fails)
    try {
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      } else {
        console.warn('Lucide icons library not loaded - icons may not display');
      }
    } catch(e) {
      console.error('Lucide init error:', e);
    }

    // Mobile Quick Bar - Update active state
    function updateMobileQuickBar() {
      var currentTab = document.querySelector('.tab-content:not(.hidden)')?.id?.replace('tab-', '') || 'blueprint';
      document.querySelectorAll('.mqb-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.tab === currentTab);
      });
    }

    // Update on tab switch
    var origSwitchTabMobile = window.switchTab;
    window.switchTab = function(tabId) {
      if (origSwitchTabMobile) origSwitchTabMobile(tabId);
      updateMobileQuickBar();
    };
  </script>
</body>
</html>
